(window.webpackJsonp=window.webpackJsonp||[]).push([[49],{120:function(e,t,r){"use strict";r.r(t),r.d(t,"frontMatter",(function(){return i})),r.d(t,"metadata",(function(){return s})),r.d(t,"toc",(function(){return c})),r.d(t,"default",(function(){return b}));var n=r(3),o=r(7),a=(r(0),r(176)),i={slug:"sre/known-issues/harbor",title:"Known Issues: Harbor",sidebar_label:"Harbor"},s={unversionedId:"ki-harbor",id:"ki-harbor",isDocsHomePage:!1,title:"Known Issues: Harbor",description:"When working with Harbor you can expect to run into the following issues:",source:"@site/docs/ki-harbor.md",slug:"/sre/known-issues/harbor",permalink:"/docs/sre/known-issues/harbor",editUrl:"https://github.com/redkubes/redkubes.github.io/tree/master/docs/ki-harbor.md",version:"current",sidebar_label:"Harbor",sidebar:"mainSidebar",previous:{title:"Known Issues: Current Otomi CLI",permalink:"/docs/sre/known-issues/cli"},next:{title:"Known Issues: Istio",permalink:"/docs/sre/known-issues/istio"}},c=[{value:"Docker login",id:"docker-login",children:[]},{value:"OIDC: conflicting user",id:"oidc-conflicting-user",children:[]},{value:"Pod multi-attach error",id:"pod-multi-attach-error",children:[]}],l={toc:c};function b(e){var t=e.components,r=Object(o.a)(e,["components"]);return Object(a.b)("wrapper",Object(n.a)({},l,r,{components:t,mdxType:"MDXLayout"}),Object(a.b)("p",null,"When working with Harbor you can expect to run into the following issues:"),Object(a.b)("h2",{id:"docker-login"},"Docker login"),Object(a.b)("p",null,"Unfortunately Harbor has not yet delivered a user friendly mechanism for users to interface with their registry via docker cli. To use docker cli one has to login with the registry EVERY time before using the cli. At the same time this fails when one is not logged into the Harbor dashboard beforehand. In order to login without issues one has to follow these steps:"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},"ONLY ONCE: get the cli secret from the Harbor dashboard (via User Profile)."),Object(a.b)("li",{parentName:"ul"},"refresh Harbor dashboard web view (this will refresh the OIDC auth token)"),Object(a.b)("li",{parentName:"ul"},"docker login using the cli secret as password: ",Object(a.b)("inlineCode",{parentName:"li"},"docker login harbor.<cluster-domain> -u < User_Name > -p <CLI secret>")),Object(a.b)("li",{parentName:"ul"},"do your docker pull/push etc within the token TTL window (60 secs)")),Object(a.b)("p",null,"Usually this is not a problem as team users don't pull or push these images directly. We are working on solving this, and expect to have a fix soon."),Object(a.b)("h2",{id:"oidc-conflicting-user"},"OIDC: conflicting user"),Object(a.b)("p",null,Object(a.b)("strong",{parentName:"p"},"Problem:")),Object(a.b)("p",null,"Error while logging in to harbor with OIDC: ",Object(a.b)("inlineCode",{parentName:"p"},"Conflict, the user with same username or email has been onboarded."),"."),Object(a.b)("p",null,Object(a.b)("strong",{parentName:"p"},"Cause:")),Object(a.b)("p",null,"By redeploing keycloak the same user gets a new ",Object(a.b)("inlineCode",{parentName:"p"},"sub")," claim in ",Object(a.b)("inlineCode",{parentName:"p"},"openid")," scope. Harbor uses ",Object(a.b)("inlineCode",{parentName:"p"},"sub")," and ",Object(a.b)("inlineCode",{parentName:"p"},"iss")," claims in order to match them to a user from its database (see: ",Object(a.b)("inlineCode",{parentName:"p"},"subiss")," column at ",Object(a.b)("inlineCode",{parentName:"p"},"oidc_user")," table in ",Object(a.b)("inlineCode",{parentName:"p"},"registry")," database). If the same user identifies with a new sub then harbor tries to create a new entry in the ",Object(a.b)("inlineCode",{parentName:"p"},"harbor_user")," database table and it fails on the username column uniqueness constraint."),Object(a.b)("p",null,Object(a.b)("strong",{parentName:"p"},"Solution:")),Object(a.b)("p",null,"Please check up on this link when this problem occurs, because a fix might already be released: ",Object(a.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/goharbor/harbor/issues/13674"}),"goharbor/harbor#13674"),". If so, please create a PR to fix this in the ",Object(a.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/redkubes/otomi-core"}),"otomi-core")," repo, or create an issue there. Otherwise continue:"),Object(a.b)("p",null,"Connect to the database service"),Object(a.b)("pre",null,Object(a.b)("code",Object(n.a)({parentName:"pre"},{}),"kh exec harbor-harbor-database-0 -it -- psql -U postgres\n")),Object(a.b)("p",null,"Select the ",Object(a.b)("inlineCode",{parentName:"p"},"registry")," database"),Object(a.b)("pre",null,Object(a.b)("code",Object(n.a)({parentName:"pre"},{className:"language-sql"}),"\\c registry\n")),Object(a.b)("p",null,"Find out the ",Object(a.b)("inlineCode",{parentName:"p"},"<user_id>")),Object(a.b)("pre",null,Object(a.b)("code",Object(n.a)({parentName:"pre"},{className:"language-sql"}),"SELECT user_id FROM harbor_user WHERE username = '<user name>';\n")),Object(a.b)("p",null,"Remove the user from the database"),Object(a.b)("pre",null,Object(a.b)("code",Object(n.a)({parentName:"pre"},{className:"language-sql"}),"DELETE FROM oidc_user WHERE user_id = <userid>;\nDELETE FROM harbor_user WHERE user_id = <userid>;\n")),Object(a.b)("p",null,"Exit psql"),Object(a.b)("pre",null,Object(a.b)("code",Object(n.a)({parentName:"pre"},{}),"\\q\n")),Object(a.b)("p",null,"Try to login once again and observe that you are asked to confirm your username."),Object(a.b)("h2",{id:"pod-multi-attach-error"},"Pod multi-attach error"),Object(a.b)("p",null,Object(a.b)("strong",{parentName:"p"},"Problem")),Object(a.b)("p",null,"Kubernetes cannot schedule the ",Object(a.b)("inlineCode",{parentName:"p"},"harbor-harbor-registry")," Pod."),Object(a.b)("p",null,Object(a.b)("strong",{parentName:"p"},"Cause")),Object(a.b)("p",null,"Multi-Attach error occurs for persistent volumes that support only one writer at a time."),Object(a.b)("p",null,Object(a.b)("strong",{parentName:"p"},"Solution")),Object(a.b)("p",null,"Delete an existing harbor registry replicaset. Note that this operation makes registry temporarely unavailable."))}b.isMDXComponent=!0},176:function(e,t,r){"use strict";r.d(t,"a",(function(){return u})),r.d(t,"b",(function(){return h}));var n=r(0),o=r.n(n);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function i(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function s(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?i(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function c(e,t){if(null==e)return{};var r,n,o=function(e,t){if(null==e)return{};var r,n,o={},a=Object.keys(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||(o[r]=e[r]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}var l=o.a.createContext({}),b=function(e){var t=o.a.useContext(l),r=t;return e&&(r="function"==typeof e?e(t):s(s({},t),e)),r},u=function(e){var t=b(e.components);return o.a.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return o.a.createElement(o.a.Fragment,{},t)}},d=o.a.forwardRef((function(e,t){var r=e.components,n=e.mdxType,a=e.originalType,i=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),u=b(r),d=n,h=u["".concat(i,".").concat(d)]||u[d]||p[d]||a;return r?o.a.createElement(h,s(s({ref:t},l),{},{components:r})):o.a.createElement(h,s({ref:t},l))}));function h(e,t){var r=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var a=r.length,i=new Array(a);i[0]=d;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:n,i[1]=s;for(var l=2;l<a;l++)i[l]=r[l];return o.a.createElement.apply(null,i)}return o.a.createElement.apply(null,r)}d.displayName="MDXCreateElement"}}]);