"use strict";(self.webpackChunkredkubes_github_io=self.webpackChunkredkubes_github_io||[]).push([[7980],{33:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>a,metadata:()=>i,toc:()=>c});var r=t(5893),s=t(1151);const a={slug:"azure",title:"Azure",sidebar_label:"Azure"},o="Install Otomi on AKS with DNS",i={id:"get-started/installation/azure",title:"Azure",description:"Prerequisites",source:"@site/docs/get-started/installation/azure.md",sourceDirName:"get-started/installation",slug:"/get-started/installation/azure",permalink:"/docs/get-started/installation/azure",draft:!1,unlisted:!1,editUrl:"https://github.com/redkubes/redkubes.github.io/tree/main/docs/get-started/installation/azure.md",tags:[],version:"current",frontMatter:{slug:"azure",title:"Azure",sidebar_label:"Azure"},sidebar:"mainSidebar",previous:{title:"AWS",permalink:"/docs/get-started/installation/aws"},next:{title:"Civo",permalink:"/docs/get-started/installation/civo"}},l={},c=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Create an AKS cluster",id:"create-an-aks-cluster",level:2},{value:"Configure DNS",id:"configure-dns",level:2},{value:"Create an Azure DNS zone",id:"create-an-azure-dns-zone",level:3},{value:"Create a Service Principal",id:"create-a-service-principal",level:3},{value:"Create the values.yaml file",id:"create-the-valuesyaml-file",level:2},{value:"Install Otomi using helm",id:"install-otomi-using-helm",level:2}];function d(e){const n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"install-otomi-on-aks-with-dns",children:"Install Otomi on AKS with DNS"}),"\n",(0,r.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://docs.microsoft.com/en-us/cli/azure/install-azure-cli",children:"Azure CLI"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://jqlang.github.io/jq/download/",children:"jq"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/tools/",children:"kubectl"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/tools/",children:"Helm"})}),"\n"]}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:["Note: If you login via ",(0,r.jsx)(n.a,{href:"https://shell.azure.com",children:"Azure Cloud Shell"}),", you don't need to install the prerequisites"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Azure CLI Cheat Sheet"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Sign in to Azure\naz login\n# Get a list of subscriptions for the logged in account\naz account list\n# Set subscription\naz account set --subscription=<subscription_id>\n"})}),"\n",(0,r.jsx)(n.h2,{id:"create-an-aks-cluster",children:"Create an AKS cluster"}),"\n",(0,r.jsx)(n.p,{children:"Setting the environment variables"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Set Resource Group Name \nRGNAME=rg-otomi\n# Set Region (Location) or any other location\nLOCATION=westeurope\n# Create Resource Group\naz group create -n $RGNAME -l $LOCATION\n# Set Cluster name\nCLUSTER_NAME=otomi\n"})}),"\n",(0,r.jsx)(n.p,{children:"Creating the cluster"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Create AKS cluster\naz aks create --name $CLUSTER_NAME \\\n--resource-group $RGNAME \\\n--location $LOCATION \\\n--zones 1 2 \\\n--vm-set-type VirtualMachineScaleSets \\\n--nodepool-name otomipool \\\n--node-count 3 \\\n--node-vm-size Standard_F8s_v2 \\\n--kubernetes-version 1.27.3 \\\n--enable-cluster-autoscaler \\\n--min-count 1 \\\n--max-count 6 \\\n--max-pods 100 \\\n--network-plugin azure \\\n--network-policy calico \\\n--outbound-type loadBalancer \\\n--generate-ssh-keys\n"})}),"\n",(0,r.jsx)(n.p,{children:"Update the Kubernetes config file"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"az aks get-credentials -n $CLUSTER_NAME -g $RGNAME\n"})}),"\n",(0,r.jsx)(n.h2,{id:"configure-dns",children:"Configure DNS"}),"\n",(0,r.jsx)(n.h3,{id:"create-an-azure-dns-zone",children:"Create an Azure DNS zone"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Create a resource group:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'$ az group create --name "MyDnsResourceGroup" --location $LOCATION\n'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Create a Azure DNS zone for example.com:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'$ az network dns zone create --resource-group "MyDnsResourceGroup" --name "example.com"\n'})}),"\n",(0,r.jsx)(n.p,{children:"Substitute a domain you own for example.com if desired."}),"\n",(0,r.jsxs)(n.p,{children:["If using your own domain that was registered with a third-party domain registrar, you should point your domain's name servers to the values in the ",(0,r.jsx)(n.code,{children:"nameServers"})," field from the JSON data returned by the ",(0,r.jsx)(n.code,{children:"az network dns zone create"})," command. Please consult your registrar's documentation on how to do that."]}),"\n",(0,r.jsx)(n.h3,{id:"create-a-service-principal",children:"Create a Service Principal"}),"\n",(0,r.jsx)(n.p,{children:"Create a Service Principal with a minimum access level of DNS Zone Contributor or Contributor to the DNS zone(s) and Reader to the resource group containing the Azure DNS zone(s)."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'$ DNS_NEW_SP_NAME="ExternalDnsServicePrincipal" # name of the service principal\n$ AZURE_DNS_ZONE_RESOURCE_GROUP="MyDnsResourceGroup" # name of resource group where dns zone is hosted\n$ AZURE_DNS_ZONE="example.com" # DNS zone name like example.com or sub.example.com\n\n# Create the service principal\n$ DNS_SP=$(az ad sp create-for-rbac --name $DNS_NEW_SP_NAME)\n$ DNS_SP_APP_ID=$(echo $DNS_SP | jq -r \'.appId\')\n$ DNS_SP_PASSWORD=$(echo $DNS_SP | jq -r \'.password\')\n'})}),"\n",(0,r.jsx)(n.p,{children:"Grant access to Azure DNS zone for the service principal."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'# fetch DNS id used to grant access to the service principal\nDNS_ID=$(az network dns zone show --name $AZURE_DNS_ZONE \\\n --resource-group $AZURE_DNS_ZONE_RESOURCE_GROUP --query "id" --output tsv)\n\n# 1. as a reader to the resource group\n$ az role assignment create --role "Reader" --assignee $DNS_SP_APP_ID --scope $DNS_ID\n\n# 2. as a contributor to DNS Zone itself\n$ az role assignment create --role "Contributor" --assignee $DNS_SP_APP_ID --scope $DNS_ID\n'})}),"\n",(0,r.jsx)(n.h2,{id:"create-the-valuesyaml-file",children:"Create the values.yaml file"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'tee values.yaml<<EOF\ncluster:\n  name: otomi\n  provider: azure\n  domainSuffix: azure.example.com\notomi:\n  hasExternalDNS: true\ndns:\n  domainFilters: \n    - example.com\n  provider:\n    azure:\n      resourceGroup: $AZURE_DNS_ZONE_RESOURCE_GROUP\n      aadClientId: $DNS_SP_APP_ID\n      aadClientSecret: $DNS_SP_PASSWORD\n      tenantId: "$(az account show --query tenantId -o tsv)"\n      subscriptionId: "$(az account show --query id -o tsv)"\napps:\n  cert-manager:\n    issuer: letsencrypt\n    stage: production\n    email: admin@example.com\nEOF\n'})}),"\n",(0,r.jsxs)(n.p,{children:["And adjust the ",(0,r.jsx)(n.code,{children:"domainSuffix"}),", ",(0,r.jsx)(n.code,{children:"domainFilters"})," and ",(0,r.jsx)(n.code,{children:"email"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"install-otomi-using-helm",children:"Install Otomi using helm"}),"\n",(0,r.jsx)(n.p,{children:"Install Otomi using Helm:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"helm repo add otomi https://otomi.io/otomi-core\nhelm repo update\nhelm install -f values.yaml otomi otomi/otomi\n"})}),"\n",(0,r.jsx)(n.p,{children:"Monitor the logs of the installer job:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"kubectl logs jobs/otomi -n default -f\n"})}),"\n",(0,r.jsxs)(n.p,{children:["When the installer is finished, copy the ",(0,r.jsx)(n.code,{children:"url"})," and ",(0,r.jsx)(n.code,{children:"admin-password"})," from the console output."]}),"\n",(0,r.jsxs)(n.p,{children:["Follow the activation steps ",(0,r.jsx)(n.a,{href:"https://otomi.io/docs/get-started/activation",children:"here."})]}),"\n",(0,r.jsx)(n.admonition,{type:"tip",children:(0,r.jsxs)(n.p,{children:["Like to learn how to use Otomi? Go through the ",(0,r.jsx)(n.a,{href:"/docs/get-started/labs/overview",children:"Get Started labs"})]})})]})}function u(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},1151:(e,n,t)=>{t.d(n,{Z:()=>i,a:()=>o});var r=t(7294);const s={},a=r.createContext(s);function o(e){const n=r.useContext(a);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);