"use strict";(self.webpackChunkredkubes_github_io=self.webpackChunkredkubes_github_io||[]).push([[9892],{5399:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>l,toc:()=>d});var t=s(5893),i=s(1151);const r={slug:"tutorial-9",title:"Configuring network policies",sidebar_label:"Configuring network policies"},o=void 0,l={id:"tutorials/tutorial-9",title:"Configuring network policies",description:"In this tutorial we are going to deploy a multi tier web application, called guestbook, register the 3 K8s services in Otomi and configure public access to the frontend service. Next, we will turn on the Network policies option for the team.",source:"@site/docs/tutorials/tutorial-9.md",sourceDirName:"tutorials",slug:"/tutorials/tutorial-9",permalink:"/docs/tutorials/tutorial-9",draft:!1,unlisted:!1,editUrl:"https://github.com/redkubes/redkubes.github.io/tree/main/docs/tutorials/tutorial-9.md",tags:[],version:"current",frontMatter:{slug:"tutorial-9",title:"Configuring network policies",sidebar_label:"Configuring network policies"}},c={},d=[{value:"Instructions",id:"instructions",level:2}];function a(e){const n={admonition:"admonition",code:"code",em:"em",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,i.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.p,{children:["In this tutorial we are going to deploy a multi tier web application, called ",(0,t.jsx)(n.code,{children:"guestbook"}),", register the 3 K8s services in Otomi and configure public access to the ",(0,t.jsx)(n.code,{children:"frontend"})," service. Next, we will turn on the ",(0,t.jsx)(n.code,{children:"Network policies"})," option for the team."]}),"\n",(0,t.jsx)(n.h2,{id:"instructions",children:"Instructions"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Install the Guestbook application resources:"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl apply -f https://raw.githubusercontent.com/redkubes/workshops/main/04-netpols/guestbook.yaml -n team-$TEAM-NAME\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"2",children:["\n",(0,t.jsx)(n.li,{children:"Get the names of the created ClusterIP services:"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl get svc -n team-<$TEAM-NAME>\n"})}),"\n",(0,t.jsx)(n.p,{children:"You will see 3 services:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"NAME             TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE\nfrontend         ClusterIP   10.0.183.235   <none>        80/TCP     6m44s\nredis-follower   ClusterIP   10.0.135.61    <none>        6379/TCP   6m44s\nredis-leader     ClusterIP   10.0.82.226    <none>        6379/TCP   6m44s\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"3",children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Go to Otomi Console. Make sure you have selected your team in the top bar en and then click the ",(0,t.jsx)(n.code,{children:"Services"})," item under your team in the side menu."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["We will now first add the created frontend service to Otomi. Click ",(0,t.jsx)(n.code,{children:"Create Service"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Fill in the name ",(0,t.jsx)(n.code,{children:"frontend"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Under ",(0,t.jsx)(n.code,{children:"Exposure"}),", select ",(0,t.jsx)(n.code,{children:"Ingress"}),". Leave all other settings under exposure default."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Leave all other settings default and click ",(0,t.jsx)(n.code,{children:"submit"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Click ",(0,t.jsx)(n.code,{children:"Deploy Changes"}),"."]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.admonition,{type:"info",children:(0,t.jsxs)(n.p,{children:["After the changes have been deployed (this will take a couple of minutes), you will see that the service we just created has a host name. Click on the host name to get access to the ",(0,t.jsx)(n.code,{children:"guestbook"})," frontend. submit a few messages on the application."]})}),"\n",(0,t.jsxs)(n.ol,{start:"9",children:["\n",(0,t.jsxs)(n.li,{children:["Register the ",(0,t.jsx)(n.code,{children:"redis-follower"})," and ",(0,t.jsx)(n.code,{children:"redis-leader"})," services via the otomi-console. Make sure to provide the correct port (",(0,t.jsx)(n.strong,{children:"6379"}),") and leave all other settings default (so no exposure) and ",(0,t.jsx)(n.code,{children:"submit"}),". You don't need to ",(0,t.jsx)(n.code,{children:"Deploy Changes"})," after every submit."]}),"\n"]}),"\n",(0,t.jsx)(n.admonition,{type:"info",children:(0,t.jsxs)(n.p,{children:["When you create a service in Otomi with ingress ",(0,t.jsx)(n.code,{children:"Cluster"}),", the K8s service will be added to the service-mesh in Otomi. When you create services in Otomi, the Istio Gateway is automatically configured and Istio virtual services are also automatically created."]})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.em,{children:"Notice that the guestbook frontend still works!"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["In Otomi Console go to your team and then click the ",(0,t.jsx)(n.code,{children:"Settings"})," item."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Under Network policy, enable ",(0,t.jsx)(n.code,{children:"Network policies"}),". Click ",(0,t.jsx)(n.code,{children:"submit"})," and then ",(0,t.jsx)(n.code,{children:"Deploy Changes"})]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.admonition,{type:"info",children:(0,t.jsxs)(n.p,{children:["Now go to the Guestbook application and notice that your messages have disappeared and you can't submit new messages. This is because traffic between the ",(0,t.jsx)(n.code,{children:"frontend"})," and the ",(0,t.jsx)(n.code,{children:"redis-leader"})," and ",(0,t.jsx)(n.code,{children:"redis-follower"})," services is not permitted anymore."]})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.em,{children:"Let's fix this"})}),"\n",(0,t.jsxs)(n.ol,{start:"12",children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["In the otomi-console, click on the ",(0,t.jsx)(n.code,{children:"redis-leader"})," service."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Under ",(0,t.jsx)(n.code,{children:"Network policies"}),", select ",(0,t.jsx)(n.code,{children:"Allow selected"})," and click ",(0,t.jsx)(n.code,{children:"add item"}),". Add the following 2 items and submit:"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Team name"}),(0,t.jsx)(n.th,{children:"Service Name"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"$TEAM-NAME"}),(0,t.jsx)(n.td,{children:"frontend"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"$TEAM-NAME"}),(0,t.jsx)(n.td,{children:"redis-follower"})]})]})]}),"\n",(0,t.jsxs)(n.p,{children:["Before deploying changes, go to the ",(0,t.jsx)(n.code,{children:"redis-follower"})," service and do the same, but in this case only allow the frontend service:"]}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Team name"}),(0,t.jsx)(n.th,{children:"Service Name"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"$TEAM-NAME"}),(0,t.jsx)(n.td,{children:"frontend"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"$TEAM-NAME"}),(0,t.jsx)(n.td,{children:"redis-leader"})]})]})]}),"\n",(0,t.jsxs)(n.p,{children:["Now ",(0,t.jsx)(n.code,{children:"Deploy Changes"})]}),"\n",(0,t.jsx)(n.p,{children:"Notice that the Guestbook app works again."})]})}function h(e={}){const{wrapper:n}={...(0,i.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}},1151:(e,n,s)=>{s.d(n,{Z:()=>l,a:()=>o});var t=s(7294);const i={},r=t.createContext(i);function o(e){const n=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);