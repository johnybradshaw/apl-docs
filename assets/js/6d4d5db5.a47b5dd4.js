"use strict";(self.webpackChunkredkubes_github_io=self.webpackChunkredkubes_github_io||[]).push([[1676],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return m}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),u=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=u(e.components);return a.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),d=u(n),m=r,g=d["".concat(s,".").concat(m)]||d[m]||c[m]||o;return n?a.createElement(g,i(i({ref:t},p),{},{components:n})):a.createElement(g,i({ref:t},p))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var u=2;u<o;u++)i[u]=n[u];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},3283:function(e,t,n){n.r(t),n.d(t,{assets:function(){return p},contentTitle:function(){return s},default:function(){return m},frontMatter:function(){return l},metadata:function(){return u},toc:function(){return c}});var a=n(7462),r=n(3366),o=(n(7294),n(3905)),i=["components"],l={slug:"installation/optional",title:"Optional configuration"},s=void 0,u={unversionedId:"inst-optional",id:"inst-optional",title:"Optional configuration",description:"You can optionally configure Otomi to use an external IDP (Azure AD), use an external Key Management Service (KMS) provider for SOPS and use a DNS zone in combination with LetsEncrpt certificates. Below you can find detailed instructions on how to set up Azure AD as an external IDP and configure KMS. We will soon add more instructions for other IDPs, such as Amazon Incognito, Google Identity, and Okta.",source:"@site/docs/inst-optional.md",sourceDirName:".",slug:"/installation/optional",permalink:"/docs/installation/optional",editUrl:"https://github.com/redkubes/redkubes.github.io/tree/master/docs/inst-optional.md",tags:[],version:"current",frontMatter:{slug:"installation/optional",title:"Optional configuration"},sidebar:"mainSidebar",previous:{title:"Prerequisites",permalink:"/docs/installation/prerequisites"},next:{title:"Install from chart",permalink:"/docs/installation/chart"}},p={},c=[{value:"Use DNS and Let&#39;s Encrypt",id:"use-dns-and-lets-encrypt",level:2},{value:"Use Azure AD as IDP",id:"use-azure-ad-as-idp",level:2},{value:"Use KMS to manage keys for encryption",id:"use-kms-to-manage-keys-for-encryption",level:2}],d={toc:c};function m(e){var t=e.components,n=(0,r.Z)(e,i);return(0,o.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"You can optionally configure Otomi to use an external IDP (Azure AD), use an external Key Management Service (KMS) provider for SOPS and use a DNS zone in combination with LetsEncrpt certificates. Below you can find detailed instructions on how to set up Azure AD as an external IDP and configure KMS. We will soon add more instructions for other IDPs, such as Amazon Incognito, Google Identity, and Okta."),(0,o.kt)("h2",{id:"use-dns-and-lets-encrypt"},"Use DNS and Let's Encrypt"),(0,o.kt)("p",null,"By default, Otomi uses the public IP address of the load balancer for nameresolving using ",(0,o.kt)("a",{parentName:"p",href:"http://nip.io"},"nip.io"),". To use DNS with LetsEncrypt, follow these instructions:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/kubernetes-sigs/external-dns/blob/master/docs/tutorials/aws.md"},"Setting up external DNS in AWS")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/kubernetes-sigs/external-dns/blob/master/docs/tutorials/azure.md"},"Setting up external DNS in Azure")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/kubernetes-sigs/external-dns/blob/master/docs/tutorials/gke.md"},"Setting up external DNS in Google"))),(0,o.kt)("p",null,"To install Otomi with DNS and Let's Encrypt, use the following values:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"otomi:\n  hasExternalDNS: true\napps:\n  cert-manager:\n    issuer: letsencrypt\n    stage: staging # defaults to 'production' when commented out\n  external-dns:\n    domainFilters:\n      - ''\n# Configure your DNS provider\ndns:\n#   provider: # provide one of the following below: aws|azure|google\n#     aws:\n#       # next two keys are optional for explicit access with an iam role\n#       # (if no metadata exists with implicit role access to manage dns)\n#       accessKeySecret: ''\n#       secretAccessKey: ''\n#       # region is always needed\n#       region: eu-central-1\n#       role: '' # optional ARN, may be set explicitly if no metadata can be accessed\n#     azure:\n#       aadClientId: ''\n#       aadClientSecret: ''\n#       tenantId: '' # optional\n#       subscriptionId: '' # optional\n#     google:\n#       serviceAccountKey: ''\n#       project: ''\n")),(0,o.kt)("h2",{id:"use-azure-ad-as-idp"},"Use Azure AD as IDP"),(0,o.kt)("p",null,"The authentication of brokered identities through Azure AD requires a service principal with certain Azure AD API permissions. An app registration needs to be created with the following API permissions:"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"API / Permission name"),(0,o.kt)("th",{parentName:"tr",align:null},"Type"),(0,o.kt)("th",{parentName:"tr",align:null},"Description"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Microsoft Graph / email"),(0,o.kt)("td",{parentName:"tr",align:null},"Delegated"),(0,o.kt)("td",{parentName:"tr",align:null},"View users' email address")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Microsoft Graph / openid"),(0,o.kt)("td",{parentName:"tr",align:null},"Delegated"),(0,o.kt)("td",{parentName:"tr",align:null},"Sign users in")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Microsoft Graph / profile"),(0,o.kt)("td",{parentName:"tr",align:null},"Delegated"),(0,o.kt)("td",{parentName:"tr",align:null},"View users' basic profile")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Microsoft Graph / User.Read"),(0,o.kt)("td",{parentName:"tr",align:null},"Delegated"),(0,o.kt)("td",{parentName:"tr",align:null},"Sign in and read user profile")))),(0,o.kt)("p",null,"And the following token configurations:"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"Claim"),(0,o.kt)("th",{parentName:"tr",align:null},"Description"),(0,o.kt)("th",{parentName:"tr",align:null},"Token type"),(0,o.kt)("th",{parentName:"tr",align:null},"Optional settings"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"family_name"),(0,o.kt)("td",{parentName:"tr",align:null},"Provides the last name, surename, or family name"),(0,o.kt)("td",{parentName:"tr",align:null},"ID"),(0,o.kt)("td",{parentName:"tr",align:null},"-")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"given_name"),(0,o.kt)("td",{parentName:"tr",align:null},'Provides the first or "give" name of the user'),(0,o.kt)("td",{parentName:"tr",align:null},"ID"),(0,o.kt)("td",{parentName:"tr",align:null},"-")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"groups"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional formatting for group claims"),(0,o.kt)("td",{parentName:"tr",align:null},"ID, Access, SAML"),(0,o.kt)("td",{parentName:"tr",align:null},"Default")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"upn"),(0,o.kt)("td",{parentName:"tr",align:null},"An identifier for the user that can be used ..."),(0,o.kt)("td",{parentName:"tr",align:null},"ID"),(0,o.kt)("td",{parentName:"tr",align:null},"Default")))),(0,o.kt)("p",null,"Note that the group type should be set to 'security groups'."),(0,o.kt)("p",null,'At the \'Authentication\' tab you should be able to set the following callback URL\xa7s and enable that both "Access tokens" and "ID tokens" are issued and public client flows are allowed:'),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"https://keycloak.<dns-zone-name>/realms/master/broker/otomi-idp/endpoint")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"https://keycloak.<dns-zone-name>"))),(0,o.kt)("p",null,"To install Otomi with Azure Active Directory as IdP instead of (default) Keycloak, use the following values:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"oidc:\n  clientID: ''\n  clientSecret: ''\n  issuer: ''\n  # IDP group id used to identify global admin\n  adminGroupID: ''\n  # IDP group id used to identify team admin\n  teamAdminGroupID: ''\n")),(0,o.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},(0,o.kt)("inlineCode",{parentName:"p"},"otomi-idp")," is the default KeyCloak alias (shown as login title). To use another alias, add the following to the chart values:"),(0,o.kt)("pre",{parentName:"div"},(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"apps:\n  keycloak:\n    idp:\n      alias: <your-alias>\n")))),(0,o.kt)("h2",{id:"use-kms-to-manage-keys-for-encryption"},"Use KMS to manage keys for encryption"),(0,o.kt)("p",null,"If you would like the secrets in the ",(0,o.kt)("inlineCode",{parentName:"p"},"values")," repository to be encrypted, you will have to setup an account with your Key Management Service (KMS) provider. It is needed by ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/mozilla/sops"},"sops"),", the tool used for encryption."),(0,o.kt)("p",null,"Find quickstart documentation below on how to setup KMS access per supported provider:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://aws.amazon.com/kms/getting-started/"},"AWS KMS")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://azure.microsoft.com/en-us/services/key-vault/#getting-started"},"Azure Vault")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://cloud.google.com/kms/docs/quickstart"},"Google KMS"))),(0,o.kt)("p",null,"Follow the instructions of the provider of your choosing and jot down the credentials obtained for the next steps."),(0,o.kt)("p",null,"To install Otomi with SOPS/KMS, use the following values:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"kms:\n  sops:\n    provider: '' # provider can be one of aws|azure|google|vault\n#     aws:\n#       keys: ''\n#       accessKey: ''\n#       secretKey: ''\n#       region: ''\n#     azure:\n#       keys: ''\n#       tenantID: ''\n#       clientID: ''\n#       clientSecret: ''\n#     google:\n#       keys: ''\n#       accountJson: ''\n#       project: ''\n#     vault:\n#       token: ''\n")),(0,o.kt)("p",null,"But you can also enable SOPS/KMS after installing Otomi using Otomi Console."))}m.isMDXComponent=!0}}]);