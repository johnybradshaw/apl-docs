"use strict";(self.webpackChunkredkubes_github_io=self.webpackChunkredkubes_github_io||[]).push([[2704],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>k});var i=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,i,r=function(e,t){if(null==e)return{};var n,i,r={},a=Object.keys(e);for(i=0;i<a.length;i++)n=a[i],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(i=0;i<a.length;i++)n=a[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=i.createContext({}),u=function(e){var t=i.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=u(e.components);return i.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},d=i.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),d=u(n),k=r,m=d["".concat(l,".").concat(k)]||d[k]||p[k]||a;return n?i.createElement(m,o(o({ref:t},c),{},{components:n})):i.createElement(m,o({ref:t},c))}));function k(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,o=new Array(a);o[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var u=2;u<a;u++)o[u]=n[u];return i.createElement.apply(null,o)}return i.createElement.apply(null,n)}d.displayName="MDXCreateElement"},2444:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>a,metadata:()=>s,toc:()=>u});var i=n(7462),r=(n(7294),n(3905));const a={slug:"troubleshooting",title:"SRE Troubleshooting Checklist",sidebar_label:"Troubleshooting"},o=void 0,s={unversionedId:"for-ops/sre/troubleshooting",id:"for-ops/sre/troubleshooting",title:"SRE Troubleshooting Checklist",description:"Pods not starting",source:"@site/docs/for-ops/sre/troubleshooting.md",sourceDirName:"for-ops/sre",slug:"/for-ops/sre/troubleshooting",permalink:"/docs/for-ops/sre/troubleshooting",draft:!1,editUrl:"https://github.com/redkubes/redkubes.github.io/tree/main/docs/for-ops/sre/troubleshooting.md",tags:[],version:"current",frontMatter:{slug:"troubleshooting",title:"SRE Troubleshooting Checklist",sidebar_label:"Troubleshooting"},sidebar:"mainSidebar",previous:{title:"Upgrades",permalink:"/docs/for-ops/sre/upgrades"},next:{title:"Dashboard",permalink:"/docs/for-devs/console/dashboard"}},l={},u=[{value:"Pods not starting",id:"pods-not-starting",level:2},{value:"Advanced",id:"advanced",level:3},{value:"Pods not running",id:"pods-not-running",level:2},{value:"Advanced",id:"advanced-1",level:3},{value:"Network services not working",id:"network-services-not-working",level:2},{value:"Advanced",id:"advanced-2",level:3},{value:"Istio issues",id:"istio-issues",level:2},{value:"Advanced",id:"advanced-3",level:3},{value:"DNS issues",id:"dns-issues",level:2},{value:"Certificate issues",id:"certificate-issues",level:2},{value:"Storage issues",id:"storage-issues",level:2},{value:"The otomi-pipeline pipeline failure",id:"the-otomi-pipeline-pipeline-failure",level:3},{value:"Advanced",id:"advanced-4",level:3},{value:"Contact support (Enterprise subscription required)",id:"contact-support-enterprise-subscription-required",level:2}],c={toc:u};function p(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,i.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"pods-not-starting"},"Pods not starting"),(0,r.kt)("p",null,"Pods that are unable to start do not show any log output, the issue is related to k8s. Look for a pod with status Pending. Most of the time this is related to resources and container component issues."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Describe the pod, look closely at listed events"),(0,r.kt)("li",{parentName:"ul"},"Is the image pullable? Is there a pull secret configured?"),(0,r.kt)("li",{parentName:"ul"},"Can volumes, configmaps and secrets be mounted?"),(0,r.kt)("li",{parentName:"ul"},"Check resource requests: is the requested resource available?"),(0,r.kt)("li",{parentName:"ul"},"Are commands and arguments correct? (make sure to use /bin/sh -c as command to use ENV)"),(0,r.kt)("li",{parentName:"ul"},"Does the cluster have enough resources available?")),(0,r.kt)("h3",{id:"advanced"},"Advanced"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Check affinity and node selector rules"),(0,r.kt)("li",{parentName:"ul"},"Is the image tag valid and compatible with the host CPU? (exec format error)"),(0,r.kt)("li",{parentName:"ul"},"Check namespace quotas for pod, cm or secret limits etc."),(0,r.kt)("li",{parentName:"ul"},"Check service account and permissions"),(0,r.kt)("li",{parentName:"ul"},"Is the pod a job, deployment, daemonset or statefulset?"),(0,r.kt)("li",{parentName:"ul"},"Is there a limitrange configured in the namespace?"),(0,r.kt)("li",{parentName:"ul"},"Is the template spec in the pod matching the running container?")),(0,r.kt)("h2",{id:"pods-not-running"},"Pods not running"),(0,r.kt)("p",null,"Pods that are running but restart for whatever reason indicate that a container itself is having issues. Look for pod status ",(0,r.kt)("inlineCode",{parentName:"p"},"Crashloop, OOMkilled")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"incomplete ready status (2/3)")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Check if dns resolving works"),(0,r.kt)("li",{parentName:"ul"},"Are the required services available to the pod?"),(0,r.kt)("li",{parentName:"ul"},"Check restart count and inspect logs and previous logs"),(0,r.kt)("li",{parentName:"ul"},"Check if istio injection is required and working"),(0,r.kt)("li",{parentName:"ul"},"Is a lifecycle spec configured?"),(0,r.kt)("li",{parentName:"ul"},"Does the container depend on sidecar containers?"),(0,r.kt)("li",{parentName:"ul"},"Check for available resources requests"),(0,r.kt)("li",{parentName:"ul"},"Check readiness and liveness probes"),(0,r.kt)("li",{parentName:"ul"},"Does the pod have enough CPU resources to do it's job?"),(0,r.kt)("li",{parentName:"ul"},"Inspect the restart counter for the pod, a high value (32+) indicates an unstable pod")),(0,r.kt)("h3",{id:"advanced-1"},"Advanced"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Check pod's service account permissions"),(0,r.kt)("li",{parentName:"ul"},"Attach shell and inspect container status"),(0,r.kt)("li",{parentName:"ul"},"Rootless containers need special care combined with volumes"),(0,r.kt)("li",{parentName:"ul"},"Check securitycontext and pod security policy"),(0,r.kt)("li",{parentName:"ul"},"Check volume permissions")),(0,r.kt)("h2",{id:"network-services-not-working"},"Network services not working"),(0,r.kt)("p",null,"Pods are working but a user can't connect to the service. Most HTTP-based services use an Ingress object, non HTTP services require a service port to be defined."),(0,r.kt)("p",null,"Network policies or Istio policies can deny pods from communicating, note that DNS resolving is required for normal operation."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Check if network policies are too strict by removing suspect one(s) (if so report an issue to have it/them refactored, if not put back)"),(0,r.kt)("li",{parentName:"ul"},"Use ",(0,r.kt)("inlineCode",{parentName:"li"},"kubectl port-forward")," to debug pod service on lowest level"),(0,r.kt)("li",{parentName:"ul"},"Check if kube-dns / coredns pods are working in kube-system namespace"),(0,r.kt)("li",{parentName:"ul"},"Check invalid DNS names, too long (64+) or invalid characters"),(0,r.kt)("li",{parentName:"ul"},"Attach a shell and perform basic nslookup or ping commands (ping doesn't work between internal services in k8s)"),(0,r.kt)("li",{parentName:"ul"},"Confirm that services do not mix http and https in frontend and backend"),(0,r.kt)("li",{parentName:"ul"},"Service names matter, prefix accordingly with http- or https- for istio to recognize"),(0,r.kt)("li",{parentName:"ul"},"Validate ingress, istio gateway, virtual service and services")),(0,r.kt)("h3",{id:"advanced-2"},"Advanced"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"heck for network policies"),(0,r.kt)("li",{parentName:"ul"},"Validate istio pods are working"),(0,r.kt)("li",{parentName:"ul"},"Check if istio injection is configured and working"),(0,r.kt)("li",{parentName:"ul"},"Validate istio-operator working"),(0,r.kt)("li",{parentName:"ul"},"Run ",(0,r.kt)("inlineCode",{parentName:"li"},"istioctl analyze"))),(0,r.kt)("h2",{id:"istio-issues"},"Istio issues"),(0,r.kt)("p",null,"Istio sidecars manipulate the container's network to reroute traffic. A namespace can have an Istio sidecar policy indicated by a label, the same is valid for a deployment or pod. Make sure you see Istio sidecars running when applicable (indicated by the 3/3 Ready status)."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Check if istio-operator is working"),(0,r.kt)("li",{parentName:"ul"},"Check logs for istiod pods"),(0,r.kt)("li",{parentName:"ul"},"Are services correctly named? (istio treats http- prefix and https- prefix differently)"),(0,r.kt)("li",{parentName:"ul"},"Check logs for istio sidecar proxy"),(0,r.kt)("li",{parentName:"ul"},"Check if mtls is enabled and working")),(0,r.kt)("h3",{id:"advanced-3"},"Advanced"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Is the correct service account configured?"),(0,r.kt)("li",{parentName:"ul"},"Is Istio mTLS enabled and configured correctly?"),(0,r.kt)("li",{parentName:"ul"},"Turn on logging for a context of an istio sidecar: ",(0,r.kt)("inlineCode",{parentName:"li"},"ksh exec -it $container_id -c istio-proxy -- sh -c 'curl -k -X POST localhost:15000/logging?jwt=debug'"))),(0,r.kt)("h2",{id:"dns-issues"},"DNS issues"),(0,r.kt)("p",null,"The external-dns service is registering DNS names to makes sure that the service names are publicly available."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Make sure external-dns logs indicate All records are already up to date"),(0,r.kt)("li",{parentName:"ul"},"Are the credentials configured correctly?")),(0,r.kt)("h2",{id:"certificate-issues"},"Certificate issues"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Check cert-manager working"),(0,r.kt)("li",{parentName:"ul"},"Run ",(0,r.kt)("inlineCode",{parentName:"li"},"kubectl describe orders.acme.cert-manager.io -A")),(0,r.kt)("li",{parentName:"ul"},"Run ",(0,r.kt)("inlineCode",{parentName:"li"},"kubectl describe challenges.acme.cert-manager.io -A")),(0,r.kt)("li",{parentName:"ul"},"Run ",(0,r.kt)("inlineCode",{parentName:"li"},"kubectl describe certificates.cert-manager.io -A"))),(0,r.kt)("h2",{id:"storage-issues"},"Storage issues"),(0,r.kt)("p",null,"Check available storage classes ",(0,r.kt)("inlineCode",{parentName:"p"},"std")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"fast")," exist"),(0,r.kt)("h3",{id:"the-otomi-pipeline-pipeline-failure"},"The otomi-pipeline pipeline failure"),(0,r.kt)("p",null,"In the otomi-pipeline execution failure, read carefully last few lines from the ",(0,r.kt)("inlineCode",{parentName:"p"},"PipelineRun`` output.\nErrors containing: "),'unable to build kubernetes objects from release manifest: Get "',(0,r.kt)("a",{parentName:"p",href:"https://10.32.0.1:443/openapi/v2?timeout=32s%22"},'https://10.32.0.1:443/openapi/v2?timeout=32s"'),": net/http: request canceled",(0,r.kt)("inlineCode",{parentName:"p"},"string, indicates that the kube-api was not available. Admin can restart the pipeline by triggering webhook from Gitea app. Go to otomi/values repository -> click "),"Settings",(0,r.kt)("inlineCode",{parentName:"p"},"-> select "),"Webhooks",(0,r.kt)("inlineCode",{parentName:"p"},"tab -> click the "),"Test Delivery` button."),(0,r.kt)("h3",{id:"advanced-4"},"Advanced"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Describe pv and pvc, check if pv's are ",(0,r.kt)("inlineCode",{parentName:"li"},"rwo")," or ",(0,r.kt)("inlineCode",{parentName:"li"},"rwx")," and look for conflicts"),(0,r.kt)("li",{parentName:"ul"},"Check if container expects or ",(0,r.kt)("inlineCode",{parentName:"li"},"rwx")," pv")),(0,r.kt)("h2",{id:"contact-support-enterprise-subscription-required"},"Contact support (Enterprise subscription required)"),(0,r.kt)("p",null,"In case (after troubleshooting) the customer discovers one of the Otomi functions is not working as expected, an issue can be reported. When reporting an issue the following information needs to be provided:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Is the function not working in only a single case, or in all cases?"),(0,r.kt)("li",{parentName:"ul"},"Which function is not working?"),(0,r.kt)("li",{parentName:"ul"},"Which remediation activities have been performed?"),(0,r.kt)("li",{parentName:"ul"},"kubeLog output of the container(s) supporting this function")),(0,r.kt)("p",null,"In case the issue is caused by a bug in one of the Otomi features, then Red Kubes will provide a fix within at least 24 hours."))}p.isMDXComponent=!0}}]);