"use strict";(self.webpackChunkredkubes_github_io=self.webpackChunkredkubes_github_io||[]).push([[860],{5189:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>s,metadata:()=>a,toc:()=>d});var i=t(5893),r=t(1151);const s={slug:"lab-4",title:"Create a CI pipeline",sidebar_label:"Create a custom CI pipeline"},o=void 0,a={id:"get-started/labs/lab-4",title:"Create a CI pipeline",description:"Kubernetes is a container orchestrator, so we need to create container images that we can deploy. Next to providing a Git service. Otomi also has a complete CI solution called Drone integrated. You can use Drone to create and run CI pipelines to build images and push them to your private image registry (Harbor).",source:"@site/docs/get-started/labs/lab-4.md",sourceDirName:"get-started/labs",slug:"/get-started/labs/lab-4",permalink:"/docs/get-started/labs/lab-4",draft:!1,unlisted:!1,editUrl:"https://github.com/redkubes/redkubes.github.io/tree/main/docs/get-started/labs/lab-4.md",tags:[],version:"current",frontMatter:{slug:"lab-4",title:"Create a CI pipeline",sidebar_label:"Create a custom CI pipeline"}},l={},d=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Creating a build pipeline in Drone",id:"creating-a-build-pipeline-in-drone",level:2}];function c(e){const n={code:"code",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,r.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"Kubernetes is a container orchestrator, so we need to create container images that we can deploy. Next to providing a Git service. Otomi also has a complete CI solution called Drone integrated. You can use Drone to create and run CI pipelines to build images and push them to your private image registry (Harbor)."}),"\n",(0,i.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,i.jsx)(n.p,{children:"Before you can use Drone to run CI pipelines, you will need to have:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"A Git repository"}),"\n",(0,i.jsx)(n.li,{children:"Credentials to push images to the registry (your private registry on the platform)"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"creating-a-build-pipeline-in-drone",children:"Creating a build pipeline in Drone"}),"\n",(0,i.jsx)(n.p,{children:"In the apps section in Otomi console, you'll see an app called Drone. Click on it."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"kubecfg",src:t(1701).Z+"",width:"2944",height:"1728"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Go to the Drone dashboard, and click on \u2018SYNC\u2019. You will now see your repo pop up in the REPOSITORIES list."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"kubecfg",src:t(401).Z+"",width:"2198",height:"980"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Click on the new repo and then click \u2018ACTIVATE\u2019."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"kubecfg",src:t(1553).Z+"",width:"2196",height:"1300"})}),"\n",(0,i.jsx)(n.p,{children:"Now we\u2019ll need to add the Harbor push credentials (you can download the credentials in the Otomi Console) as secrets to Drone:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Click on your repository."}),"\n",(0,i.jsx)(n.li,{children:"Under Settings, Click on secrets"}),"\n",(0,i.jsx)(n.li,{children:"Add the following 2 secrets:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"REGISTRY_USERNAME = <harbor-account-name.\nREGISTRY_PASSWORD = <the-token-of-the-account-name>\n"})}),"\n",(0,i.jsx)(n.p,{children:"Now you'll need to add a Drone pipeline definition to our repo."}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Add a ",(0,i.jsx)(n.code,{children:".drone.yml"})," file to your repo. This is an example you can use:"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"kind: pipeline\ntype: kubernetes\nname: default\nsteps:\n  - name: build-push\n    image: plugins/docker\n    settings:\n      registry: harbor.<yourdomain>\n      repo: harbor.<your-ip>.nip.io/team-demo/hello\n      insecure: true\n      username:\n        from_secret: REGISTRY_USERNAME\n      password:\n        from_secret: REGISTRY_PASSWORD\n      tags:\n        - ${DRONE_BRANCH}\n"})}),"\n",(0,i.jsx)(n.p,{children:"Make sure to adjust the registry and repo name in the .drone.yml file"}),"\n",(0,i.jsx)(n.p,{children:"In Drone, you will see the pipeline has automatically started building and then pushing the new image to Harbor."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"kubecfg",src:t(2954).Z+"",width:"1248",height:"804"})}),"\n",(0,i.jsx)(n.p,{children:"If you use Harbor as a private registry, check to see if the repo has been created. You can now also use Trivy in Harbor to scan your image(s) for vulnerabilities."})]})}function p(e={}){const{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},1553:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/drone-activate-repo-33218e943848cdf3a4fdc9ed9b166a29.png"},2954:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/drone-pipeline-85d054e8007b3d3dde79395387900660.png"},401:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/repo-sync-cf209a43badf49d44c1e666a0bd3b6bc.png"},1701:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/team-app-drone-0d7fc083e50ae1146ba7b062f1b22580.png"},1151:(e,n,t)=>{t.d(n,{Z:()=>a,a:()=>o});var i=t(7294);const r={},s=i.createContext(r);function o(e){const n=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);