"use strict";(self.webpackChunkredkubes_github_io=self.webpackChunkredkubes_github_io||[]).push([[1113],{2226:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>r,toc:()=>c});var o=n(5893),i=n(1151);const s={slug:"loki",title:"Loki",sidebar_label:"Loki"},a=void 0,r={id:"apps/loki",title:"Loki",description:"Loki aggregates all the container logs from the platform and stores them in a storage endpoint of choice (defaults to PVC). When Otomi is installed in multi-tenancy mode (see here) it will split logs from team namespaces and make them available only to team members. Otomi provides shortcuts to selections of logs based on interest. Otomi splits logs per team, installs a dedicated Grafana instance per team and configures authentication for Grafana to allow access for team members only.",source:"@site/docs/apps/loki.md",sourceDirName:"apps",slug:"/apps/loki",permalink:"/docs/apps/loki",draft:!1,unlisted:!1,editUrl:"https://github.com/redkubes/redkubes.github.io/tree/main/docs/apps/loki.md",tags:[],version:"current",frontMatter:{slug:"loki",title:"Loki",sidebar_label:"Loki"},sidebar:"mainSidebar",previous:{title:"Knative",permalink:"/docs/apps/knative"},next:{title:"Minio",permalink:"/docs/apps/minio"}},l={},c=[{value:"Setup with GCS",id:"setup-with-gcs",level:2},{value:"Known issues",id:"known-issues",level:2},{value:"Time Range does not show all data",id:"time-range-does-not-show-all-data",level:3}];function d(e){const t={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,i.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(t.p,{children:["Loki aggregates all the container logs from the platform and stores them in a storage endpoint of choice (defaults to PVC). When Otomi is installed in multi-tenancy mode (see ",(0,o.jsx)(t.a,{href:"/docs/for-ops/console/settings/otomi",children:"here"}),") it will split logs from team namespaces and make them available only to team members. Otomi provides shortcuts to selections of logs based on interest. Otomi splits logs per team, installs a dedicated Grafana instance per team and configures authentication for Grafana to allow access for team members only."]}),"\n",(0,o.jsx)(t.h2,{id:"setup-with-gcs",children:"Setup with GCS"}),"\n",(0,o.jsxs)(t.p,{children:["When using Google Cloud Storage as a backend in combination with Google Kubernetes Engine, authentication can be set up using workload identity federation. The following instructions provide a service account, that can be set in the ",(0,o.jsx)(t.code,{children:"serviceAccount"})," field when selecting the GCS option for Loki storage."]}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:["Make sure the cluster supports the feature. It needs to be activated on the cluster as well as each node pool. This will possibly require draining nodes temporarily, so account for extra capacity. Follow the instructions in the ",(0,o.jsx)(t.a,{href:"https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity",children:"GKE docs"})," to set up the required API and update cluster and node pool. Follow the rest of the instructions below."]}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsx)(t.p,{children:"Create a GCS storage bucket to use for Loki, if possible in the same project as the Otomi cluster."}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsx)(t.p,{children:"Create a IAM service account. Note that the project name should match the project of the storage bucket and the GKE cluster. This is not strictly required, but cross-project access may have to be granted separately."}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{children:"gcloud iam service-accounts create $SA_NAME --project=$PROJECT\n"})}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsx)(t.p,{children:"Grant the role access to your storage bucket."}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{children:'gcloud projects add-iam-policy-binding $PROJECT \\\n--member="serviceAccount:$SA_NAME@$PROJECT.iam.gserviceaccount.com" \\\n--project $PROJECT \\\n--role="roles/storage.objectAdmin"\n'})}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsx)(t.p,{children:"Create a policy binding, allowing resources with the Kubernetes ServiceAccount to impersonate the IAM service account:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{children:'gcloud iam service-accounts add-iam-policy-binding --project $PROJECT $SA_NAME \\\n--role roles/iam.workloadIdentityUser \\\n--member "serviceAccount:$PROJECT.svc.id.goog[monitoring/loki]"\n'})}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:["Provide the service account in the GCS storage values for Loki, in the full notation ",(0,o.jsx)(t.code,{children:"$SA_NAME@$PROJECT.iam.gserviceaccount.com"})," and deploy."]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(t.h2,{id:"known-issues",children:"Known issues"}),"\n",(0,o.jsx)(t.h3,{id:"time-range-does-not-show-all-data",children:"Time Range does not show all data"}),"\n",(0,o.jsx)(t.p,{children:'Unfortunately the Grafana team has not yet solved their long running problems with their LogQL interface. Instead of providing paginated queries to Loki, it is needed to provide a "line limit" by the user manually.'}),"\n",(0,o.jsx)(t.p,{children:"In a data driven application that has pagination, when a user selects a time window for a data query, the user will not have to provide additional information to perform that query. The UI application takes responsibility for instrumenting the query towards its data backend. It should thus load & render the results either through pagination or by scrolling the time range into view."}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.strong,{children:"Solution:"})}),"\n",(0,o.jsx)(t.p,{children:"When you don't see enough data, try increasing the line limit. The maximum is configurable in the Loki values."})]})}function h(e={}){const{wrapper:t}={...(0,i.a)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},1151:(e,t,n)=>{n.d(t,{Z:()=>r,a:()=>a});var o=n(7294);const i={},s=o.createContext(i);function a(e){const t=o.useContext(s);return o.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),o.createElement(s.Provider,{value:t},e.children)}}}]);