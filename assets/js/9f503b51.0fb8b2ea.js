"use strict";(self.webpackChunkredkubes_github_io=self.webpackChunkredkubes_github_io||[]).push([[9449],{3905:(e,t,o)=>{o.d(t,{Zo:()=>u,kt:()=>h});var a=o(7294);function n(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function r(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,a)}return o}function l(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?r(Object(o),!0).forEach((function(t){n(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):r(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function s(e,t){if(null==e)return{};var o,a,n=function(e,t){if(null==e)return{};var o,a,n={},r=Object.keys(e);for(a=0;a<r.length;a++)o=r[a],t.indexOf(o)>=0||(n[o]=e[o]);return n}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)o=r[a],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(n[o]=e[o])}return n}var i=a.createContext({}),p=function(e){var t=a.useContext(i),o=t;return e&&(o="function"==typeof e?e(t):l(l({},t),e)),o},u=function(e){var t=p(e.components);return a.createElement(i.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var o=e.components,n=e.mdxType,r=e.originalType,i=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),c=p(o),h=n,d=c["".concat(i,".").concat(h)]||c[h]||m[h]||r;return o?a.createElement(d,l(l({ref:t},u),{},{components:o})):a.createElement(d,l({ref:t},u))}));function h(e,t){var o=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var r=o.length,l=new Array(r);l[0]=c;var s={};for(var i in t)hasOwnProperty.call(t,i)&&(s[i]=t[i]);s.originalType=e,s.mdxType="string"==typeof e?e:n,l[1]=s;for(var p=2;p<r;p++)l[p]=o[p];return a.createElement.apply(null,l)}return a.createElement.apply(null,o)}c.displayName="MDXCreateElement"},7626:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>i,contentTitle:()=>l,default:()=>m,frontMatter:()=>r,metadata:()=>s,toc:()=>p});var a=o(7462),n=(o(7294),o(3905));const r={slug:"backups",title:"Create/Restore backups",sidebar_label:"Backups"},l=void 0,s={unversionedId:"for-ops/how-to/create-and-restore-backups",id:"for-ops/how-to/create-and-restore-backups",title:"Create/Restore backups",description:"When Velero is activated on the platform level, platform admins can create backups of Persistent Volumes (PVs) in Team namespaces using Otomi Console. When creating backups using Otomi Console, a Velero schedule resource is created that will create the backup at a specified time, defined by a Cron expression.",source:"@site/docs/for-ops/how-to/create-and-restore-backups.md",sourceDirName:"for-ops/how-to",slug:"/for-ops/how-to/backups",permalink:"/docs/for-ops/how-to/backups",draft:!1,editUrl:"https://github.com/redkubes/redkubes.github.io/tree/main/docs/for-ops/how-to/create-and-restore-backups.md",tags:[],version:"current",frontMatter:{slug:"backups",title:"Create/Restore backups",sidebar_label:"Backups"},sidebar:"mainSidebar",previous:{title:"Install with DNS",permalink:"/docs/for-ops/how-to/install-with-dns"},next:{title:"Installation",permalink:"/docs/for-ops/cli/installation"}},i={},p=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Create a backup schedule using Otomi",id:"create-a-backup-schedule-using-otomi",level:2},{value:"Check if the schedule is created",id:"check-if-the-schedule-is-created",level:2},{value:"Check if the backup is created",id:"check-if-the-backup-is-created",level:2},{value:"Restore the backup",id:"restore-the-backup",level:2},{value:"Create custom backups",id:"create-custom-backups",level:2}],u={toc:p};function m(e){let{components:t,...o}=e;return(0,n.kt)("wrapper",(0,a.Z)({},u,o,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("p",null,"When Velero is activated on the platform level, platform admins can create backups of Persistent Volumes (PVs) in Team namespaces using Otomi Console. When creating backups using Otomi Console, a Velero ",(0,n.kt)("inlineCode",{parentName:"p"},"schedule")," resource is created that will create the backup at a specified time, defined by a Cron expression."),(0,n.kt)("p",null,"In this how-to, we'll create a backup of a PV using Otomi and then restore it using the velero CLI integrated into the Otomi Shell."),(0,n.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,n.kt)("p",null,"To perform this how-to, first make sure Velero is enabled. Velero requires object storage to be be configured. By default Velero uses the local Minio provided by Otomi."),(0,n.kt)("p",null,"When Otomi installs Velero, the Velero plug-in for Azure, AWS and Google are configured by default. Velero also has support for backing up and restoring Kubernetes volumes using ",(0,n.kt)("a",{parentName:"p",href:"https://velero.io/docs/v1.3.2/restic/#limitations"},"Restic"),". Note that Restic is not configured by default."),(0,n.kt)("p",null,"For this how-to we'll use the PV of a Team's private Prometheus instance, so make sure Prometheus is also enabled. The Prometheus pod in the team namespace does not have the ",(0,n.kt)("inlineCode",{parentName:"p"},"backup.velero.io/backup-volumes")," annotation. "),(0,n.kt)("p",null,"Add the annotation:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"In Otomi Console, click on ",(0,n.kt)("inlineCode",{parentName:"li"},"Shell")," in the bottom of the left menu"),(0,n.kt)("li",{parentName:"ol"},"Run the following cmd in the shell:")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl get po -n team-demo\nNAME                              READY   STATUS    RESTARTS   AGE\nprometheus-demo-po-prometheus-0   3/3     Running   0          52m\n\nkubectl get pod prometheus-demo-po-prometheus-0 -n team-demo -o yaml\n")),(0,n.kt)("p",null,"In the output you will see that the volume used by Prometheus is ",(0,n.kt)("inlineCode",{parentName:"p"},"prometheus-demo-po-prometheus-db"),":"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"Volumes:\n  prometheus-demo-po-prometheus-db:\n    Type:       PersistentVolumeClaim (a reference to a PersistentVolumeClaim in the same namespace)\n    ClaimName:  prometheus-demo-po-prometheus-db-prometheus-demo-po-prometheus-0\n    ReadOnly:   false\n")),(0,n.kt)("ol",{start:3},(0,n.kt)("li",{parentName:"ol"},"Annotate the pod:")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl -n team-demo annotate pod prometheus-demo-po-prometheus-0 backup.velero.io/backup-volumes=prometheus-demo-po-prometheus-db\npod/prometheus-demo-po-prometheus-0 annotate\n")),(0,n.kt)("p",null,"and verify the pod has been annotated:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl -n team-demo describe pod prometheus-demo-po-prometheus-0 | grep Annotations\nAnnotations: backup.velero.io/backup-volumes: prometheus-demo-po-prometheus-db\n")),(0,n.kt)("h2",{id:"create-a-backup-schedule-using-otomi"},"Create a backup schedule using Otomi"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Select the Team name in the top bar to set the context to the namespace that contains the PV to backup. In this how-to we'll use the team ",(0,n.kt)("inlineCode",{parentName:"li"},"demo"),"."),(0,n.kt)("li",{parentName:"ol"},"In Otomi Console, click on ",(0,n.kt)("inlineCode",{parentName:"li"},"Backup")," in the left menu under ",(0,n.kt)("inlineCode",{parentName:"li"},"Platform")," and click on ",(0,n.kt)("inlineCode",{parentName:"li"},"Create"),"."),(0,n.kt)("li",{parentName:"ol"},"Enter a name for the backup. In this how-to we'll use the name ",(0,n.kt)("inlineCode",{parentName:"li"},"prom"),"."),(0,n.kt)("li",{parentName:"ol"},"Add the schedule of the backup. The schedule is a cron-type expression to schedule the backup. Defaults to once a day at 00:00. Create your cron-type expression ",(0,n.kt)("a",{parentName:"li",href:"https://crontab.guru/"},"here"),"."),(0,n.kt)("li",{parentName:"ol"},"Using snapshots only applies to Persistent Volumes in Azure, GCE, and AWS"),(0,n.kt)("li",{parentName:"ol"},"In this how-to, we'll create a backup of the private Prometheus PV in the ",(0,n.kt)("inlineCode",{parentName:"li"},"demo")," team. ")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"In Otomi Console, click on ",(0,n.kt)("inlineCode",{parentName:"li"},"Shell")," in the bottom of the left menu."),(0,n.kt)("li",{parentName:"ul"},"Run the following cmd in the shell:")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl get statefulset prometheus-demo-po-prometheus -n team-demo --show-labels\n\\NAME                            READY   AGE   LABELS\nprometheus-demo-po-prometheus   1/1     77m   app.kubernetes.io/instance=prometheus-demo,app.kubernetes.io/managed-by=Helm,app.kubernetes.io/part-of=demo-po,app.kubernetes.io/version=46.4.1,app=demo-po-prometheus,chart=kube-prometheus-stack-46.4.1,heritage=Helm,operator.prometheus.io/mode=server,operator.prometheus.io/name=demo-po-prometheus,operator.prometheus.io/shard=0,prometheus=team-demo,release=prometheus-demo\n")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"click on ",(0,n.kt)("inlineCode",{parentName:"li"},"Add Item")," and fill in the following:")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"name: prometheus\nvalue: team-demo\n")),(0,n.kt)("ol",{start:7},(0,n.kt)("li",{parentName:"ol"},"Use the default TTL (expiration of the backup). Defaults to 7 days."),(0,n.kt)("li",{parentName:"ol"},"Click ",(0,n.kt)("inlineCode",{parentName:"li"},"Submit"))),(0,n.kt)("h2",{id:"check-if-the-schedule-is-created"},"Check if the schedule is created"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"In Otomi Console, click on ",(0,n.kt)("inlineCode",{parentName:"li"},"Shell")," in the bottom of the left menu"),(0,n.kt)("li",{parentName:"ol"},"Run the following cmd in the shell:")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"velero get schedules\nNAME                    STATUS    CREATED                         SCHEDULE     BACKUP TTL   LAST BACKUP   SELECTOR   PAUSED\nteam-demo-backup-prom   Enabled   2023-09-24 11:50:59 +0000 UTC   55 * * * *   168h0m0s     n/a           <none>     false\n")),(0,n.kt)("h2",{id:"check-if-the-backup-is-created"},"Check if the backup is created"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Run the following cmd in the shell:")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"velero get backups\nNAME                                   STATUS      ERRORS   WARNINGS   CREATED                         EXPIRES   STORAGE LOCATION   SELECTOR\nteam-demo-backup-prom-20230924115514   Completed   0        0          2023-09-24 11:55:14 +0000 UTC   6d        otomi              prometheus=team-demo\n")),(0,n.kt)("p",null,"You can see the status of the backup is ",(0,n.kt)("inlineCode",{parentName:"p"},"Completed"),". The backup is now stored in the local Minio."),(0,n.kt)("h2",{id:"restore-the-backup"},"Restore the backup"),(0,n.kt)("p",null,"Now the backup is created, we can restore the backup."),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Run the following cmd in the shell:")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},'velero restore create --from-backup team-demo-backup-prom-20230924115514\nRestore request "team-demo-backup-prom-20230924115514-20230924133133" submitted successfully.\nRun `velero restore describe team-demo-backup-prom-20230924115514-20230924133133` or `velero restore logs team-demo-backup-prom-20230924115514-20230924133133` for more details.\n')),(0,n.kt)("h2",{id:"create-custom-backups"},"Create custom backups"),(0,n.kt)("p",null,"Otomi only provides an easy self-service option for administrators to schedule backups of persistent volumes. The shell in Otomi includes the Velero CLI, so if you're confortable with Velero you can also create you're own custom backups. Check the docs on ",(0,n.kt)("a",{parentName:"p",href:"https://velero.io/"},"https://velero.io/")," for more information."))}m.isMDXComponent=!0}}]);