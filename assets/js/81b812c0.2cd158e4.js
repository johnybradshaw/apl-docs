"use strict";(self.webpackChunkredkubes_github_io=self.webpackChunkredkubes_github_io||[]).push([[7980],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>d});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),u=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},c=function(e){var t=u(e.components);return a.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),m=u(n),d=r,h=m["".concat(s,".").concat(d)]||m[d]||p[d]||o;return n?a.createElement(h,l(l({ref:t},c),{},{components:n})):a.createElement(h,l({ref:t},c))}));function d(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,l=new Array(o);l[0]=m;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:r,l[1]=i;for(var u=2;u<o;u++)l[u]=n[u];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},954:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>p,frontMatter:()=>o,metadata:()=>i,toc:()=>u});var a=n(7462),r=(n(7294),n(3905));const o={slug:"azure",title:"Azure",sidebar_label:"Azure"},l="Install Otomi on AKS with DNS",i={unversionedId:"get-started/installation/azure",id:"get-started/installation/azure",title:"Azure",description:"Prerequisites",source:"@site/docs/get-started/installation/azure.md",sourceDirName:"get-started/installation",slug:"/get-started/installation/azure",permalink:"/docs/get-started/installation/azure",draft:!1,editUrl:"https://github.com/redkubes/redkubes.github.io/tree/main/docs/get-started/installation/azure.md",tags:[],version:"current",frontMatter:{slug:"azure",title:"Azure",sidebar_label:"Azure"},sidebar:"mainSidebar",previous:{title:"AWS",permalink:"/docs/get-started/installation/aws"},next:{title:"Civo",permalink:"/docs/get-started/installation/civo"}},s={},u=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Create an AKS cluster",id:"create-an-aks-cluster",level:2},{value:"Configure DNS",id:"configure-dns",level:2},{value:"Create an Azure DNS zone",id:"create-an-azure-dns-zone",level:3},{value:"Create a Service Principal",id:"create-a-service-principal",level:3},{value:"Create the values.yaml file",id:"create-the-valuesyaml-file",level:2},{value:"Install Otomi using helm",id:"install-otomi-using-helm",level:2}],c={toc:u};function p(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"install-otomi-on-aks-with-dns"},"Install Otomi on AKS with DNS"),(0,r.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://docs.microsoft.com/en-us/cli/azure/install-azure-cli"},"Azure CLI")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://jqlang.github.io/jq/download/"},"jq")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/tasks/tools/"},"kubectl")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/tasks/tools/"},"Helm"))),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Note: If you login via ",(0,r.kt)("a",{parentName:"p",href:"https://shell.azure.com"},"Azure Cloud Shell"),", you don't need to install the prerequisites")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Azure CLI Cheat Sheet")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# Sign in to Azure\naz login\n# Get a list of subscriptions for the logged in account\naz account list\n# Set subscription\naz account set --subscription=<subscription_id>\n")),(0,r.kt)("h2",{id:"create-an-aks-cluster"},"Create an AKS cluster"),(0,r.kt)("p",null,"Setting the environment variables"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# Set Resource Group Name \nRGNAME=rg-otomi\n# Set Region (Location) or any other location\nLOCATION=westeurope\n# Create Resource Group\naz group create -n $RGNAME -l $LOCATION\n# Set Cluster name\nCLUSTER_NAME=otomi\n")),(0,r.kt)("p",null,"Creating the cluster"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# Create AKS cluster\naz aks create --name $CLUSTER_NAME \\\n--resource-group $RGNAME \\\n--location $LOCATION \\\n--zones 1 2 \\\n--vm-set-type VirtualMachineScaleSets \\\n--nodepool-name otomipool \\\n--node-count 3 \\\n--node-vm-size Standard_F8s_v2 \\\n--kubernetes-version 1.27.3 \\\n--enable-cluster-autoscaler \\\n--min-count 1 \\\n--max-count 6 \\\n--max-pods 100 \\\n--network-plugin azure \\\n--network-policy calico \\\n--outbound-type loadBalancer \\\n--generate-ssh-keys\n")),(0,r.kt)("p",null,"Update the Kubernetes config file"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"az aks get-credentials -n $CLUSTER_NAME -g $RGNAME\n")),(0,r.kt)("h2",{id:"configure-dns"},"Configure DNS"),(0,r.kt)("h3",{id:"create-an-azure-dns-zone"},"Create an Azure DNS zone"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Create a resource group:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'$ az group create --name "MyDnsResourceGroup" --location $LOCATION\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Create a Azure DNS zone for example.com:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'$ az network dns zone create --resource-group "MyDnsResourceGroup" --name "example.com"\n')),(0,r.kt)("p",null,"Substitute a domain you own for example.com if desired."),(0,r.kt)("p",null,"If using your own domain that was registered with a third-party domain registrar, you should point your domain's name servers to the values in the ",(0,r.kt)("inlineCode",{parentName:"p"},"nameServers")," field from the JSON data returned by the ",(0,r.kt)("inlineCode",{parentName:"p"},"az network dns zone create")," command. Please consult your registrar's documentation on how to do that."),(0,r.kt)("h3",{id:"create-a-service-principal"},"Create a Service Principal"),(0,r.kt)("p",null,"Create a Service Principal with a minimum access level of DNS Zone Contributor or Contributor to the DNS zone(s) and Reader to the resource group containing the Azure DNS zone(s)."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'$ DNS_NEW_SP_NAME="ExternalDnsServicePrincipal" # name of the service principal\n$ AZURE_DNS_ZONE_RESOURCE_GROUP="MyDnsResourceGroup" # name of resource group where dns zone is hosted\n$ AZURE_DNS_ZONE="example.com" # DNS zone name like example.com or sub.example.com\n\n# Create the service principal\n$ DNS_SP=$(az ad sp create-for-rbac --name $DNS_NEW_SP_NAME)\n$ DNS_SP_APP_ID=$(echo $DNS_SP | jq -r \'.appId\')\n$ DNS_SP_PASSWORD=$(echo $DNS_SP | jq -r \'.password\')\n')),(0,r.kt)("p",null,"Grant access to Azure DNS zone for the service principal."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'# fetch DNS id used to grant access to the service principal\nDNS_ID=$(az network dns zone show --name $AZURE_DNS_ZONE \\\n --resource-group $AZURE_DNS_ZONE_RESOURCE_GROUP --query "id" --output tsv)\n\n# 1. as a reader to the resource group\n$ az role assignment create --role "Reader" --assignee $DNS_SP_APP_ID --scope $DNS_ID\n\n# 2. as a contributor to DNS Zone itself\n$ az role assignment create --role "Contributor" --assignee $DNS_SP_APP_ID --scope $DNS_ID\n')),(0,r.kt)("h2",{id:"create-the-valuesyaml-file"},"Create the values.yaml file"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'tee values.yaml<<EOF\ncluster:\n  name: otomi\n  provider: azure\n  domainSuffix: azure.example.com\notomi:\n  hasExternalDNS: true\ndns:\n  domainFilters: \n    - example.com\n  provider:\n    azure:\n      resourceGroup: $AZURE_DNS_ZONE_RESOURCE_GROUP\n      aadClientId: $DNS_SP_APP_ID\n      aadClientSecret: $DNS_SP_PASSWORD\n      tenantId: "$(az account show --query tenantId -o tsv)"\n      subscriptionId: "$(az account show --query id -o tsv)"\napps:\n  cert-manager:\n    issuer: letsencrypt\n    stage: production\n    email: admin@example.com\nEOF\n')),(0,r.kt)("p",null,"And adjust the ",(0,r.kt)("inlineCode",{parentName:"p"},"domainSuffix"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"domainFilters")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"email"),"."),(0,r.kt)("h2",{id:"install-otomi-using-helm"},"Install Otomi using helm"),(0,r.kt)("p",null,"Install Otomi using Helm:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"helm repo add otomi https://otomi.io/otomi-core\nhelm repo update\nhelm install -f values.yaml otomi otomi/otomi\n")),(0,r.kt)("p",null,"Monitor the logs of the installer job:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl logs jobs/otomi -n default -f\n")),(0,r.kt)("p",null,"When the installer is finished, copy the ",(0,r.kt)("inlineCode",{parentName:"p"},"url")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"admin-password")," from the console output."),(0,r.kt)("p",null,"Follow the activation steps ",(0,r.kt)("a",{parentName:"p",href:"https://otomi.io/docs/get-started/activation"},"here.")))}p.isMDXComponent=!0}}]);