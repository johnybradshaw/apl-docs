"use strict";(self.webpackChunkredkubes_github_io=self.webpackChunkredkubes_github_io||[]).push([[9464],{3905:(e,t,a)=>{a.d(t,{Zo:()=>u,kt:()=>c});var n=a(7294);function l(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){l(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function r(e,t){if(null==e)return{};var a,n,l=function(e,t){if(null==e)return{};var a,n,l={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(l[a]=e[a]);return l}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(l[a]=e[a])}return l}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},u=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var a=e.components,l=e.mdxType,o=e.originalType,s=e.parentName,u=r(e,["components","mdxType","originalType","parentName"]),m=p(a),c=l,h=m["".concat(s,".").concat(c)]||m[c]||d[c]||o;return a?n.createElement(h,i(i({ref:t},u),{},{components:a})):n.createElement(h,i({ref:t},u))}));function c(e,t){var a=arguments,l=t&&t.mdxType;if("string"==typeof e||l){var o=a.length,i=new Array(o);i[0]=m;var r={};for(var s in t)hasOwnProperty.call(t,s)&&(r[s]=t[s]);r.originalType=e,r.mdxType="string"==typeof e?e:l,i[1]=r;for(var p=2;p<o;p++)i[p]=a[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}m.displayName="MDXCreateElement"},4262:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>r,toc:()=>p});var n=a(7462),l=(a(7294),a(3905));const o={slug:"installation",title:"Installation",sidebar_label:"Installation"},i=void 0,r={unversionedId:"get-started/installation",id:"get-started/installation",title:"Installation",description:"Prerequisites",source:"@site/docs/get-started/installation.md",sourceDirName:"get-started",slug:"/get-started/installation",permalink:"/docs/get-started/installation",draft:!1,editUrl:"https://github.com/redkubes/redkubes.github.io/tree/main/docs/get-started/installation.md",tags:[],version:"current",frontMatter:{slug:"installation",title:"Installation",sidebar_label:"Installation"},sidebar:"mainSidebar",previous:{title:"Introduction",permalink:"/docs/"},next:{title:"Architecture",permalink:"/docs/product/architecture"}},s={},p=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Client binaries",id:"client-binaries",level:3},{value:"Supported Providers",id:"supported-providers",level:3},{value:"Azure (AKS)",id:"azure-aks",level:4},{value:"Amazon Web Services (EKS)",id:"amazon-web-services-eks",level:4},{value:"Google Cloud Platform (GKE)",id:"google-cloud-platform-gke",level:4},{value:"Digital Ocean",id:"digital-ocean",level:4},{value:"OVHcloud",id:"ovhcloud",level:4},{value:"Vultr (VKE)",id:"vultr-vke",level:4},{value:"All others",id:"all-others",level:4},{value:"Kubernetes versions",id:"kubernetes-versions",level:3},{value:"Minimal compute resource requirements",id:"minimal-compute-resource-requirements",level:3},{value:"CNI",id:"cni",level:3},{value:"Installation",id:"installation",level:2},{value:"Install Otomi with Helm",id:"install-otomi-with-helm",level:3},{value:"Add the Otomi repository",id:"add-the-otomi-repository",level:4},{value:"Minimal configuration**",id:"minimal-configuration",level:4},{value:"Custom values",id:"custom-values",level:4},{value:"Install the Chart",id:"install-the-chart",level:4},{value:"Monitoring the chart install",id:"monitoring-the-chart-install",level:4},{value:"Installing from source",id:"installing-from-source",level:3},{value:"Download source",id:"download-source",level:4},{value:"Install",id:"install",level:4},{value:"Uninstalling Otomi",id:"uninstalling-otomi",level:2},{value:"Optional Configuration",id:"optional-configuration",level:2},{value:"Use DNS and Let&#39;s Encrypt",id:"use-dns-and-lets-encrypt",level:3},{value:"Use Azure AD as IDP",id:"use-azure-ad-as-idp",level:3},{value:"Use KMS to manage keys for encryption",id:"use-kms-to-manage-keys-for-encryption",level:3},{value:"Activation",id:"activation",level:2},{value:"Step 1: Get the log output of the installer job",id:"step-1-get-the-log-output-of-the-installer-job",level:3},{value:"Step 2 (optional): Add the auto generated CA to your keychain",id:"step-2-optional-add-the-auto-generated-ca-to-your-keychain",level:3},{value:"Step 3: Activate Drone",id:"step-3-activate-drone",level:3},{value:"Step 4 (Optional): Create a new admin user",id:"step-4-optional-create-a-new-admin-user",level:3},{value:"Step 5 (Optional): Add the URL of the Kubernetes API",id:"step-5-optional-add-the-url-of-the-kubernetes-api",level:3}],u={toc:p};function d(e){let{components:t,...a}=e;return(0,l.kt)("wrapper",(0,n.Z)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,l.kt)("h3",{id:"client-binaries"},"Client binaries"),(0,l.kt)("p",null,"When installing Otomi using the chart, make sure the following client binaries exist:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/tasks/tools/#kubectl"},"Kubectl")," to access the cluster"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://helm.sh/docs/intro/install/"},"Helm")," for helm chart installation of Otomi")),(0,l.kt)("h3",{id:"supported-providers"},"Supported Providers"),(0,l.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"We have created ",(0,l.kt)("a",{parentName:"p",href:"https://github.com/redkubes/quickstart"},"quickstarts")," for Azure, GCP, AWS, Linode, Digital Ocean and Minikube to help you spin-up a Kubernetes cluster."))),(0,l.kt)("h4",{id:"azure-aks"},"Azure (AKS)"),(0,l.kt)("p",null,"To install Otomi on a AKS cluster in Azure, use the ",(0,l.kt)("inlineCode",{parentName:"p"},"azure")," provider. The ",(0,l.kt)("inlineCode",{parentName:"p"},"azure")," provider includes creating optimized storage classes and optional integration with the  a Application Gateway Ingress Controller add-on."),(0,l.kt)("h4",{id:"amazon-web-services-eks"},"Amazon Web Services (EKS)"),(0,l.kt)("p",null,"To install Otomi on a EKS cluster in AWS, use the ",(0,l.kt)("inlineCode",{parentName:"p"},"aws")," provider."),(0,l.kt)("h4",{id:"google-cloud-platform-gke"},"Google Cloud Platform (GKE)"),(0,l.kt)("p",null,"To install Otomi on a GKE cluster in GCP, use the ",(0,l.kt)("inlineCode",{parentName:"p"},"google")," provider."),(0,l.kt)("h4",{id:"digital-ocean"},"Digital Ocean"),(0,l.kt)("p",null,"To install Otomi on a Kubernetes cluster in Digital Ocean, use the ",(0,l.kt)("inlineCode",{parentName:"p"},"digitalocean")," provider. Otomi is also available in the Digital Ocean ",(0,l.kt)("a",{parentName:"p",href:"https://marketplace.digitalocean.com/apps/otomi?refcode=476bfcac9ec9&action=deploy"},"marketplace"),"."),(0,l.kt)("h4",{id:"ovhcloud"},"OVHcloud"),(0,l.kt)("p",null,"To install Otomi on a  OVHcloud ",(0,l.kt)("a",{parentName:"p",href:"https://www.ovhcloud.com/en-gb/public-cloud/kubernetes/"},"Managed Kubernetes Service"),", use the ",(0,l.kt)("inlineCode",{parentName:"p"},"ovh")," provider."),(0,l.kt)("h4",{id:"vultr-vke"},"Vultr (VKE)"),(0,l.kt)("p",null,"To install Otomi on a ",(0,l.kt)("a",{parentName:"p",href:"https://www.vultr.com/docs/vultr-kubernetes-engine/"},"Vultr Kubernetes Engine (VKE)")," cluster, use the ",(0,l.kt)("inlineCode",{parentName:"p"},"vultr")," provider."),(0,l.kt)("h4",{id:"all-others"},"All others"),(0,l.kt)("p",null,"Use the ",(0,l.kt)("inlineCode",{parentName:"p"},"custom")," provider for all other clouds, and when running Kubernetes on your own hardware (including Minikube on your local machine). The custom provider uses the default available storage classes. The only requirement for using the custom provider is to be able to create a Kubernetes LoadBalancer Service that obtains an external accessible IP."),(0,l.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"NOTE")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"When using Minikube, only Otomi Core apps can be used! Activating more apps will require more compute resources. We advise to have a node pool available with at least 12 vCPU and 32 GiB memory."))),(0,l.kt)("h3",{id:"kubernetes-versions"},"Kubernetes versions"),(0,l.kt)("p",null,"Otomi currently supports the following Kubernetes versions:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"1.18")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"1.19")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"1.20")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"1.21")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"1.22")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"1.23"))),(0,l.kt)("h3",{id:"minimal-compute-resource-requirements"},"Minimal compute resource requirements"),(0,l.kt)("p",null,"Otomi requires a node pool with at least ",(0,l.kt)("strong",{parentName:"p"},"6 vCPU")," threads and ",(0,l.kt)("strong",{parentName:"p"},"8GiB+ RAM"),". Note that this is the requirements for a minimal (default) install. When activating more apps, you'll probably need more resources."),(0,l.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"ATTENTION")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"The minimal resource requirement to run Otomi is based on running Core Apps only! The core apps provide an advanced ingress architecture based on Nginx, Istio, Keycloak, Oaut2 Proxy and Certmanager. Activating optional apps will require more compute resources. We advise to have a node pool available with 12 vCPU and 32 GiB memory."))),(0,l.kt)("h3",{id:"cni"},"CNI"),(0,l.kt)("p",null,"To use the network policies feature in Otomi, make sure to install the ",(0,l.kt)("a",{parentName:"p",href:"https://www.tigera.io/project-calico/"},"Calico")," CNI or any other CNI that supports Kubernetes network polices."),(0,l.kt)("h2",{id:"installation"},"Installation"),(0,l.kt)("h3",{id:"install-otomi-with-helm"},"Install Otomi with Helm"),(0,l.kt)("h4",{id:"add-the-otomi-repository"},"Add the Otomi repository"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"helm repo add otomi https://otomi.io/otomi-core\nhelm repo update\n")),(0,l.kt)("p",null,"See ",(0,l.kt)("a",{parentName:"p",href:"https://helm.sh/docs/helm/helm_repo/"},"helm repo")," for command documentation."),(0,l.kt)("h4",{id:"minimal-configuration"},"Minimal configuration**"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},'cluster:\n  k8sVersion: "1.23" # currently 1.18, 1.19, 1.20, 1.21, 1.22 and 1.23 are supported\n  name: # the name of your cluster\n  provider: # choose between aws, azure, google, digitalocean or custom\n')),(0,l.kt)("h4",{id:"custom-values"},"Custom values"),(0,l.kt)("p",null,"To view the required ",(0,l.kt)("inlineCode",{parentName:"p"},"values.yaml")," file with detailed comments, view and download the chart's latest ",(0,l.kt)("a",{parentName:"p",href:"https://github.com/redkubes/otomi-core/blob/main/chart/otomi/values.yaml"},"values.yaml"),". Run the following command to view ",(0,l.kt)("em",{parentName:"p"},"all")," the values (which might be overwhelming):"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"helm show values otomi/otomi\n")),(0,l.kt)("p",null,"To test wether the input values are correct run the following command:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"helm template -f values.yaml otomi/otomi\n")),(0,l.kt)("h4",{id:"install-the-chart"},"Install the Chart"),(0,l.kt)("p",null,"Install the chart with the following command:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"helm install -f values.yaml otomi otomi/otomi\n")),(0,l.kt)("h4",{id:"monitoring-the-chart-install"},"Monitoring the chart install"),(0,l.kt)("p",null,"The chart deploys a Job (",(0,l.kt)("inlineCode",{parentName:"p"},"otomi"),") in the ",(0,l.kt)("inlineCode",{parentName:"p"},"default")," namespace. Monitor the chart install using ",(0,l.kt)("inlineCode",{parentName:"p"},"kubectl"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"# get the status of the job\nkubectl get job otomi -w\n# watch the helm chart install status:\nwatch helm list -Aa\n")),(0,l.kt)("p",null,"Or view detailed info about kubernetes resources with ",(0,l.kt)("a",{parentName:"p",href:"https://k9scli.io"},"k9s")),(0,l.kt)("h3",{id:"installing-from-source"},"Installing from source"),(0,l.kt)("p",null,"As an alternative, you can also clone the otomi-core source code from the ",(0,l.kt)("a",{parentName:"p",href:"https://github.com/redkubes/otomi-core"},"Github")," and install otomi using the chart source code."),(0,l.kt)("h4",{id:"download-source"},"Download source"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"git clone https://github.com/redkubes/otomi-core.git\ncd otomi-core\n")),(0,l.kt)("h4",{id:"install"},"Install"),(0,l.kt)("p",null,"Now customize the ",(0,l.kt)("inlineCode",{parentName:"p"},"values.yaml")," file."),(0,l.kt)("p",null,"Use the following command to install the chart with the name ",(0,l.kt)("inlineCode",{parentName:"p"},"my-otomi-release")," (a custom name that you choose)."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"helm install -f values.yaml my-otomi-release chart/otomi\n")),(0,l.kt)("h2",{id:"uninstalling-otomi"},"Uninstalling Otomi"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"helm uninstall my-otomi-release\n")),(0,l.kt)("p",null,"Doing a Helm uninstall will only remove the job used to deploy Otomi. It will not remove all the installed components. If you would like to do a complete uninstall, we advise to first clone the ",(0,l.kt)("inlineCode",{parentName:"p"},"otomi/values")," repository (to secure the configuration) and then uninstall using Otomi CLI."),(0,l.kt)("h2",{id:"optional-configuration"},"Optional Configuration"),(0,l.kt)("p",null,"You can optionally configure Otomi to use an external IDP (Azure AD), use an external Key Management Service (KMS) provider for SOPS and use a DNS zone in combination with LetsEncrpt certificates. Below you can find detailed instructions on how to set up Azure AD as an external IDP and configure KMS. We will soon add more instructions for other IDPs, such as Amazon Incognito, Google Identity, and Okta."),(0,l.kt)("h3",{id:"use-dns-and-lets-encrypt"},"Use DNS and Let's Encrypt"),(0,l.kt)("p",null,"By default, Otomi uses the public IP address of the load balancer for nameresolving using ",(0,l.kt)("a",{parentName:"p",href:"http://nip.io"},"nip.io"),". To use DNS with LetsEncrypt, follow these instructions:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://github.com/kubernetes-sigs/external-dns/blob/master/docs/tutorials/aws.md"},"Setting up external DNS in AWS")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://github.com/kubernetes-sigs/external-dns/blob/master/docs/tutorials/azure.md"},"Setting up external DNS in Azure")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://github.com/kubernetes-sigs/external-dns/blob/master/docs/tutorials/gke.md"},"Setting up external DNS in Google"))),(0,l.kt)("p",null,"To install Otomi with DNS and Let's Encrypt, use the following values:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"otomi:\n  hasExternalDNS: true\n\n# Configure cert-manager\napps:\n  cert-manager:\n    issuer: letsencrypt\n    stage: staging # defaults to 'production' when commented out\n\n# Configure DNS\ndns:\n#   domainFilters: []\n#   zoneIdFilters: []\n#   provider: # provide one of the following below: aws|azure|google\n#     aws:\n#       # next two keys are optional for explicit access with an iam role\n#       # (if no metadata exists with implicit role access to manage dns)\n#       accessKeySecret: ''\n#       secretAccessKey: ''\n#       # region is always needed\n#       region: eu-central-1\n#       role: '' # optional ARN, may be set explicitly if no metadata can be accessed\n#     azure:\n#       aadClientId: ''\n#       aadClientSecret: ''\n#       tenantId: '' # optional\n#       subscriptionId: '' # optional\n#     google:\n#       serviceAccountKey: ''\n#       project: ''\n")),(0,l.kt)("h3",{id:"use-azure-ad-as-idp"},"Use Azure AD as IDP"),(0,l.kt)("p",null,"The authentication of brokered identities through Azure AD requires a service principal with certain Azure AD API permissions. An app registration needs to be created with the following API permissions:"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"API / Permission name"),(0,l.kt)("th",{parentName:"tr",align:null},"Type"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"Microsoft Graph / email"),(0,l.kt)("td",{parentName:"tr",align:null},"Delegated"),(0,l.kt)("td",{parentName:"tr",align:null},"View users' email address")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"Microsoft Graph / openid"),(0,l.kt)("td",{parentName:"tr",align:null},"Delegated"),(0,l.kt)("td",{parentName:"tr",align:null},"Sign users in")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"Microsoft Graph / profile"),(0,l.kt)("td",{parentName:"tr",align:null},"Delegated"),(0,l.kt)("td",{parentName:"tr",align:null},"View users' basic profile")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"Microsoft Graph / User.Read"),(0,l.kt)("td",{parentName:"tr",align:null},"Delegated"),(0,l.kt)("td",{parentName:"tr",align:null},"Sign in and read user profile")))),(0,l.kt)("p",null,"And the following token configurations:"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Claim"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"),(0,l.kt)("th",{parentName:"tr",align:null},"Token type"),(0,l.kt)("th",{parentName:"tr",align:null},"Optional settings"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"family_name"),(0,l.kt)("td",{parentName:"tr",align:null},"Provides the last name, surename, or family name"),(0,l.kt)("td",{parentName:"tr",align:null},"ID"),(0,l.kt)("td",{parentName:"tr",align:null},"-")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"given_name"),(0,l.kt)("td",{parentName:"tr",align:null},'Provides the first or "give" name of the user'),(0,l.kt)("td",{parentName:"tr",align:null},"ID"),(0,l.kt)("td",{parentName:"tr",align:null},"-")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"groups"),(0,l.kt)("td",{parentName:"tr",align:null},"Optional formatting for group claims"),(0,l.kt)("td",{parentName:"tr",align:null},"ID, Access, SAML"),(0,l.kt)("td",{parentName:"tr",align:null},"Default")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"upn"),(0,l.kt)("td",{parentName:"tr",align:null},"An identifier for the user that can be used ..."),(0,l.kt)("td",{parentName:"tr",align:null},"ID"),(0,l.kt)("td",{parentName:"tr",align:null},"Default")))),(0,l.kt)("p",null,"Note that the group type should be set to 'security groups'."),(0,l.kt)("p",null,'At the \'Authentication\' tab you should be able to set the following callback URL\xa7s and enable that both "Access tokens" and "ID tokens" are issued and public client flows are allowed:'),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"https://keycloak.<dns-zone-name>/realms/master/broker/otomi-idp/endpoint")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"https://keycloak.<dns-zone-name>"))),(0,l.kt)("p",null,"To install Otomi with Azure Active Directory as IdP instead of (default) Keycloak, use the following values:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"oidc:\n  clientID: ''\n  clientSecret: ''\n  issuer: ''\n  # IDP group id used to identify global admin\n  adminGroupID: ''\n  # IDP group id used to identify team admin\n  teamAdminGroupID: ''\n")),(0,l.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},(0,l.kt)("inlineCode",{parentName:"p"},"otomi-idp")," is the default KeyCloak alias (shown as login title). To use another alias, add the following to the chart values:"),(0,l.kt)("pre",{parentName:"div"},(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"apps:\n  keycloak:\n    idp:\n      alias: <your-alias>\n")))),(0,l.kt)("h3",{id:"use-kms-to-manage-keys-for-encryption"},"Use KMS to manage keys for encryption"),(0,l.kt)("p",null,"If you would like the secrets in the ",(0,l.kt)("inlineCode",{parentName:"p"},"values")," repository to be encrypted, you will have to setup an account with your Key Management Service (KMS) provider. It is needed by ",(0,l.kt)("a",{parentName:"p",href:"https://github.com/mozilla/sops"},"sops"),", the tool used for encryption."),(0,l.kt)("p",null,"Find quickstart documentation below on how to setup KMS access per supported provider:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://aws.amazon.com/kms/getting-started/"},"AWS KMS")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://azure.microsoft.com/en-us/services/key-vault/#getting-started"},"Azure Vault")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://cloud.google.com/kms/docs/quickstart"},"Google KMS"))),(0,l.kt)("p",null,"Follow the instructions of the provider of your choosing and jot down the credentials obtained for the next steps."),(0,l.kt)("p",null,"To install Otomi with SOPS/KMS, use the following values:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"kms:\n  sops:\n    provider: '' # provider can be one of aws|azure|google|vault\n#     aws:\n#       keys: ''\n#       accessKey: ''\n#       secretKey: ''\n#       region: ''\n#     azure:\n#       keys: ''\n#       tenantID: ''\n#       clientID: ''\n#       clientSecret: ''\n#     google:\n#       keys: ''\n#       accountJson: ''\n#       project: ''\n#     vault:\n#       token: ''\n")),(0,l.kt)("p",null,"But you can also enable SOPS/KMS after installing Otomi using Otomi Console."),(0,l.kt)("h2",{id:"activation"},"Activation"),(0,l.kt)("p",null,"After Otomi is installed, Drone needs to be activated. Follow the instructions below:"),(0,l.kt)("h3",{id:"step-1-get-the-log-output-of-the-installer-job"},"Step 1: Get the log output of the installer job"),(0,l.kt)("p",null,"When the installer job (in the default namespace) has finished, copy the URL and the generated password from the bottom of the logs, sign in to the console with the provided URL, username and password."),(0,l.kt)("p",null,"Use the following command to get the logs of the installer job:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"kubectl logs jobs/otomi -n default -f\n")),(0,l.kt)("h3",{id:"step-2-optional-add-the-auto-generated-ca-to-your-keychain"},"Step 2 (optional): Add the auto generated CA to your keychain"),(0,l.kt)("p",null,"Otomi by default automatically generates a CA. The generated CA is of course not trusted on your local machine. Here are some options to prevent you from clicking away lots of security warning in your browser:"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},'In the left menu of the console, click on "Download CA"'),(0,l.kt)("li",{parentName:"ol"},"Double click the downloaded CA.crt or add the CA to your keychain on Mac using the following command:")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain ~/Downloads/ca.crt\n")),(0,l.kt)("p",null,"On Windows, use PowerShell (running as Administrator) with the Certutil:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-powershell"},"certutil.exe -addstore root <downloaded cert path>\n")),(0,l.kt)("p",null,"Or:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-powershell"},'Import-Certificate -FilePath "<downloaded cert path>" -CertStoreLocation Cert:\\LocalMachine\\Root\n# Restart the browser\n')),(0,l.kt)("p",null,"But you could also run Chrome in insecure mode:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"alias chrome-insecure='/Applications/Google\\ Chrome.app/Contents/MacOS/Google\\ Chrome --ignore-certificate-errors --ignore-urlfetcher-cert-requests &> /dev/null'\n")),(0,l.kt)("ol",{start:3},(0,l.kt)("li",{parentName:"ol"},"Optional: Restart Docker (to support pushing images to Harbor)")),(0,l.kt)("h3",{id:"step-3-activate-drone"},"Step 3: Activate Drone"),(0,l.kt)("p",null,(0,l.kt)("a",{parentName:"p",href:"https://www.drone.io/"},"Drone")," is an integral part in the deployment of Otomi cluster configuration."),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"In the side menu of Otomi Console under ",(0,l.kt)("inlineCode",{parentName:"li"},"platform")," click on the ",(0,l.kt)("strong",{parentName:"li"},"Drone")," app"),(0,l.kt)("li",{parentName:"ol"},"Click on the ",(0,l.kt)("inlineCode",{parentName:"li"},"play")," button in the top right. A new tab will open for Drone"),(0,l.kt)("li",{parentName:"ol"},"Sign in locally with as ",(0,l.kt)("inlineCode",{parentName:"li"},"otomi-admin")," and the password provided in the logs of the installer job."),(0,l.kt)("li",{parentName:"ol"},"Click on ",(0,l.kt)("inlineCode",{parentName:"li"},"Authorize Application")),(0,l.kt)("li",{parentName:"ol"},"Click on `Submit on the Complete your Drone Registration page. You don't need to fill in your Email, Full Name or Company Name if you don't want to"),(0,l.kt)("li",{parentName:"ol"},"Click on the ",(0,l.kt)("inlineCode",{parentName:"li"},"otomi/values")," repository"),(0,l.kt)("li",{parentName:"ol"},"Click on ",(0,l.kt)("inlineCode",{parentName:"li"},"+ Activate Repository"))),(0,l.kt)("h3",{id:"step-4-optional-create-a-new-admin-user"},"Step 4 (Optional): Create a new admin user"),(0,l.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"ATTENTION")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"We strongly advise to not use the default ",(0,l.kt)("inlineCode",{parentName:"p"},"otomi-admin")," account after activation and to not change the password. Store it somewhere safe and only use it in case absolutely required."))),(0,l.kt)("p",null,(0,l.kt)("a",{parentName:"p",href:"/docs/apps/keycloak#step-2-create-a-user-in-keycloak"},"Create a new user account in Keycloak")," and add the new user to the ",(0,l.kt)("inlineCode",{parentName:"p"},"otomi-admin")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"team-admin"),"."),(0,l.kt)("h3",{id:"step-5-optional-add-the-url-of-the-kubernetes-api"},"Step 5 (Optional): Add the URL of the Kubernetes API"),(0,l.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"NOTE")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"Adding the URL of the K8s cluster API is required by teams to be able to download the KUBECONFIG"))),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Under ",(0,l.kt)("inlineCode",{parentName:"li"},"Platform")," in Otomi Console, click on ",(0,l.kt)("inlineCode",{parentName:"li"},"Settings")),(0,l.kt)("li",{parentName:"ul"},"Click on ",(0,l.kt)("inlineCode",{parentName:"li"},"Cluster")),(0,l.kt)("li",{parentName:"ul"},"Add the full URL of the API server"),(0,l.kt)("li",{parentName:"ul"},"Click on ",(0,l.kt)("inlineCode",{parentName:"li"},"Submit")),(0,l.kt)("li",{parentName:"ul"},"Click on ",(0,l.kt)("inlineCode",{parentName:"li"},"Deploy Changes"))))}d.isMDXComponent=!0}}]);