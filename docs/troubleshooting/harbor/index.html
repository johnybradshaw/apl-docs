<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.69">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-L2BWYL31EZ"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-L2BWYL31EZ",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Otomi Documentation" href="/opensearch.xml"><title data-react-helmet="true">Troubleshooting: Harbor | Otomi Documentation</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Troubleshooting: Harbor | Otomi Documentation"><meta data-react-helmet="true" name="description" content="When working with Harbor you can expect to run into the following issues:"><meta data-react-helmet="true" property="og:description" content="When working with Harbor you can expect to run into the following issues:"><meta data-react-helmet="true" property="og:url" content="https://otomi.io//docs/troubleshooting/harbor"><link data-react-helmet="true" rel="shortcut icon" href="/img/otomi.ico"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link data-react-helmet="true" rel="canonical" href="https://otomi.io//docs/troubleshooting/harbor"><link rel="stylesheet" href="/styles.7307db21.css">
<link rel="preload" href="/styles.685d8af2.js" as="script">
<link rel="preload" href="/runtime~main.4d352372.js" as="script">
<link rel="preload" href="/main.db3a2c57.js" as="script">
<link rel="preload" href="/1.a6e2b253.js" as="script">
<link rel="preload" href="/52.294848d2.js" as="script">
<link rel="preload" href="/55.8462c565.js" as="script">
<link rel="preload" href="/935f2afb.8601c415.js" as="script">
<link rel="preload" href="/51.999360bc.js" as="script">
<link rel="preload" href="/2a5beccf.a8152067.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_2AhQ">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" target="_self" href="/"><img src="/img/otomi_logo.svg" alt="Site Logo" class="themedImage_2E_h themedImage--light_AouX navbar__logo"><img src="/img/otomi_logo.svg" alt="Site Logo" class="themedImage_2E_h themedImage--dark_1YPN navbar__logo"></a><a class="navbar__item navbar__link" href="/about/intro">About</a><a class="navbar__item navbar__link" href="/docs/installation">Docs</a><a class="navbar__item navbar__link" href="/docs/console">Otomi Console</a><a class="navbar__item navbar__link" href="/docs/faq">FAQ</a><a class="navbar__item navbar__link" href="/community/support">Community</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/redkubes/otomi-core" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span><span class="DocSearch-Button-Key">âŒ˜</span><span class="DocSearch-Button-Key">K</span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" target="_self" href="/"><img src="/img/otomi_logo.svg" alt="Site Logo" class="themedImage_2E_h themedImage--light_AouX navbar__logo"><img src="/img/otomi_logo.svg" alt="Site Logo" class="themedImage_2E_h themedImage--dark_1YPN navbar__logo"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/about/intro">About</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/installation">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/console">Otomi Console</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/faq">FAQ</a></li><li class="menu__list-item"><a class="menu__link" href="/community/support">Community</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/redkubes/otomi-core" target="_blank" rel="noopener noreferrer" class="menu__link header-github-link" aria-label="GitHub repository"></a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive thin-scrollbar menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Installation</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/installation">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/prerequisites">Prerequisites</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/setup">Setup</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/configuration">Configuration</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/deployment">Deployment</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Otomi Console</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/console">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/configuring-apps">Configuring apps</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/configuring-clusters">Configuring clusters</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/configuring-teams">Configuring teams</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/configuring-services">Configuring services</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/settings">Settings</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/deploy-changes">Deploy changes</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Known Issues</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/known-issues/gke-timeout">GKE timeout</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Troubleshooting</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/troubleshooting">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/troubleshooting/cli">Otomi CLI</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!" tabindex="0">Apps</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/troubleshooting/harbor">Harbor</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Lifecycle Management</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/lifecycle-management">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/upgrades">Upgrades</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">FAQ</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/faq">FAQ</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_39qw"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">Troubleshooting: Harbor</h1></header><div class="markdown"><p>When working with Harbor you can expect to run into the following issues:</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="oidc-conflicting-user"></a>OIDC: conflicting user<a class="hash-link" href="#oidc-conflicting-user" title="Direct link to heading">#</a></h2><p><strong>Problem:</strong></p><p>Error while logging in to harbor with OIDC: <code>Conflict, the user with same username or email has been onboarded.</code>.</p><p><strong>Cause:</strong></p><p>By redeploing keycloak the same user gets a new <code>sub</code> claim in <code>openid</code> scope. Harbor uses <code>sub</code> and <code>iss</code> claims in order to match them to a user from its database (see: <code>subiss</code> column at <code>oidc_user</code> table in <code>registry</code> database). If the same user identifies with a new sub then harbor tries to create a new entry in the <code>harbor_user</code> database table and it fails on the username column uniqueness constraint.</p><p><strong>Solution:</strong></p><p>Please check up on this link when this problem occurs, because a fix might already be released: <a href="https://github.com/goharbor/harbor/issues/13674" target="_blank" rel="noopener noreferrer">goharbor/harbor#13674</a>. If so, please create a PR to fix this in the <a href="https://github.com/redkubes/otomi-core" target="_blank" rel="noopener noreferrer">otomi-core</a> repo, or create an issue there. Otherwise continue:</p><p>Connect to the database service</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">kh exec harbor-harbor-database-0 -it -- psql -U postgres</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Select the <code>registry</code> database</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-sql codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">\c registry</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Find out the <code>&lt;user_id&gt;</code></p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-sql codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> user_id </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> harbor_user </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> username </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&lt;user name&gt;&#x27;</span><span class="token punctuation" style="color:#393A34">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Remove the user from the database</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-sql codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">DELETE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> oidc_user </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> user_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">userid</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DELETE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> harbor_user </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> user_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">userid</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Exit psql</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">\q</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Try to login once again and observe that you are asked to confirm your username.</p><p><strong>Note:</strong> otomi-core creates a harbor project for each team. Each harbor project is owned by the harbor admin user. Users get access to projects by group membership provided via the groups claim in the openid scope. It may happen that a user owns another project or it is assigned directly to a project. We do not support this and do not provide troubleshooting guide for that case.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/redkubes/redkubes/tree/master/docs/ts-harbor.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/troubleshooting/cli"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Troubleshooting: Otomi CLI</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/lifecycle-management"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">LM Overview Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_ thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#oidc-conflicting-user" class="table-of-contents__link">OIDC: conflicting user</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Otomi</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/about/intro">Introduction</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/console">Community Edition</a></li><li class="footer__item"><a href="https://redkubes.com/otomi-container-platform-product-sheet/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Product sheet</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/redkubes/redkubes/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Feedback</a></li><li class="footer__item"><a href="https://gitter.im/redkubes/community" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitter</a></li><li class="footer__item"><a class="footer__link-item" href="/community/support">Help</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Red Kubes</h4><ul class="footer__items"><li class="footer__item"><a href="https://redkubes.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Website</a></li><li class="footer__item"><a href="https://github.com/redkubes/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a href="https://www.linkedin.com/company/red-kubes/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIN</a></li></ul></div></div><div class="text--center"><div class="margin-bottom--sm"><img class="footer__logo" alt="Otomi Open Source Logo" src="/img/otomi_logo_small.svg"></div><div>Copyright Â© 2020 Red Kubes. Built with <a href="https://v2.docusaurus.io/">Docusaurus</a></div></div></div></footer></div>
<script src="/styles.685d8af2.js"></script>
<script src="/runtime~main.4d352372.js"></script>
<script src="/main.db3a2c57.js"></script>
<script src="/1.a6e2b253.js"></script>
<script src="/52.294848d2.js"></script>
<script src="/55.8462c565.js"></script>
<script src="/935f2afb.8601c415.js"></script>
<script src="/51.999360bc.js"></script>
<script src="/2a5beccf.a8152067.js"></script>
</body>
</html>