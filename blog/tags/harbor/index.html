<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Otomi Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Otomi Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KKV4ZVDEKQ"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-KKV4ZVDEKQ",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Otomi" href="/opensearch.xml"><title data-react-helmet="true">Posts tagged &quot;harbor&quot; | Otomi</title><meta data-react-helmet="true" property="og:title" content="Posts tagged &quot;harbor&quot; | Otomi"><meta data-react-helmet="true" name="description" content="Blog | Tagged &quot;harbor&quot;"><meta data-react-helmet="true" property="og:description" content="Blog | Tagged &quot;harbor&quot;"><meta data-react-helmet="true" property="og:image" content="https://otomi.io/img/otomi-logo.svg"><meta data-react-helmet="true" name="twitter:image" content="https://otomi.io/img/otomi-logo.svg"><meta data-react-helmet="true" name="twitter:image:alt" content="Image for Posts tagged &quot;harbor&quot; | Otomi"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/img/otomi.ico"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/styles.91a2fb7d.css">
<link rel="preload" href="/styles.fe6bfec4.js" as="script">
<link rel="preload" href="/runtime~main.564d9ca7.js" as="script">
<link rel="preload" href="/main.769c3e36.js" as="script">
<link rel="preload" href="/1.141f0f27.js" as="script">
<link rel="preload" href="/2.5f3907bd.js" as="script">
<link rel="preload" href="/3.e819809a.js" as="script">
<link rel="preload" href="/6875c492.1d39c8e8.js" as="script">
<link rel="preload" href="/382a9fb0.70587f02.js" as="script">
<link rel="preload" href="/fcfed33e.3c28ad2b.js" as="script">
<link rel="preload" href="/2a9dc24f.fe71cfd5.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" target="_self" href="/"><img src="/img/otomi-logo.svg" alt="Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/otomi-logo.svg" alt="Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"></a><a class="navbar__item navbar__link" href="/about/">About</a><a class="navbar__item navbar__link" href="/docs/installation/">Docs</a><a class="navbar__item navbar__link" href="/docs/faq">FAQ</a><a class="navbar__item navbar__link" href="/community/get-involved">Community</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/redkubes/otomi-core" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">üåú</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">üåû</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><div class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></div></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" target="_self" href="/"><img src="/img/otomi-logo.svg" alt="Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/otomi-logo.svg" alt="Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/about/">About</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/installation/">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/faq">FAQ</a></li><li class="menu__list-item"><a class="menu__link" href="/community/get-involved">Community</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/redkubes/otomi-core" target="_blank" rel="noopener noreferrer" class="menu__link header-github-link" aria-label="GitHub repository"></a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_SWld thin-scrollbar"><h3 class="sidebarItemTitle_Km2m">Recent posts</h3><ul class="sidebarItemList_3UpA"><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/harbor-keycloak-istio">Integrating Harbor, KeyCloak and Istio</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/universal-opa-policy-development">Universal OPA Policies Development</a></li></ul></div></div><main class="col col--8"><h1>1 post tagged with &quot;harbor&quot;</h1><a href="/blog/tags">View All Tags</a><div class="margin-vert--xl"><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog/harbor-keycloak-istio">Integrating Harbor, KeyCloak and Istio</a></h2><div class="margin-vert--md"><time datetime="2021-04-13T00:00:00.000Z" class="blogPostDate_Ta7i">April 13, 2021  ¬∑ 9 min read</time></div><div class="avatar margin-vert--md"><div class="avatar__intro"><h4 class="avatar__name"><a target="_blank" rel="noreferrer noopener">Jehoszafat Zimnowoda</a></h4><small class="avatar__subtitle">Developer @ Red Kubes</small></div></div></header><section class="markdown"><p>This is our initial documentation setup for Otomi Container Platform. We hope you find it useful. Please don&#x27;t hesitate to give us any <a href="https://github.com/redkubes/redkubes/issues" target="_blank" rel="noopener noreferrer">feedback</a>!</p><p>This is my story is about building a multi-tenant Kubernetes environment that facilitates various DevOps teams (tenants) with their own Kubernetes namespace and private container registry (Harbor v2.1.0) with Single-Sign-On On (Keycloak v10.0.0) and service mesh (Istio 1.6.14) included.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="harbor-a-fat-but-versatile-container-registry"></a>Harbor, A Fat But Versatile Container Registry<a class="hash-link" href="#harbor-a-fat-but-versatile-container-registry" title="Direct link to heading">#</a></h2><p>Harbor provides a container image registry, vulnerability scanning, container image signature and validation, OIDC based authentication and authorization. The fully-featured version is composed of ten micro-services. It is also CNCF graduated OSS.</p><p>In Harbor, a <a href="https://goharbor.io/docs/2.2.0/working-with-projects/create-projects/" target="_blank" rel="noopener noreferrer">project</a> represents a container image registry, exposed under a unique URL, For example, <strong>‚Äúharbor.otomi.io/team-demo/‚Äù</strong>, where <strong>team-demo</strong> is a project name.</p><p>By creating projects you can achieve a multi-tenant container image repository for workloads in your Kubernetes cluster.</p><p>In Harbor, you can also define project membership, first by defining OIDC groups and then assigning them with a given project. For example, the OIDC group team-demo is a member of a team-demo project.</p><p>Next, we want pods from a given Kubernetes namespace to pull container images from a private registry. The <a href="https://goharbor.io/docs/1.10/working-with-projects/project-configuration/create-robot-accounts/" target="_blank" rel="noopener noreferrer">Harbor robot accounts</a> are made for that purpose. I recommend creating two robot accounts in each Harbor project. The first one for using Kubernetes as a <a href="https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/" target="_blank" rel="noopener noreferrer">PullSecret</a> at a given namespace and the second one for CI/CD pipeline.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="multi-tenancy-with-keycloak-and-harbor"></a>Multi-Tenancy With Keycloak And Harbor<a class="hash-link" href="#multi-tenancy-with-keycloak-and-harbor" title="Direct link to heading">#</a></h2><p>Keycloak can be used as an identity provider. In Harbor, a user can log in by performing an <a href="https://openid.net/specs/openid-connect-core-1_0.html#CodeFlowAuth" target="_blank" rel="noopener noreferrer">OIDC authentication code flow</a> with Keycloak. Upon successful authentication, a user is redirected back to Harbor with a <a href="https://jwt.io/introduction" target="_blank" rel="noopener noreferrer">JSON Web Token</a> (JWT) signed by the identity Provider (Keycloak). The JWT contains a <a href="https://openid.net/specs/openid-connect-core-1_0.html#IDToken" target="_blank" rel="noopener noreferrer">ID token</a>.</p><p>Harbor can verify JWT signature and automatically assign a user to a role and a project, based on groups claim from the ID token.</p><p>The following code snippet present an ID token with a groups claim:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-json codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"> ‚Äúiss‚Äù</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ‚Äúhttps</span><span class="token operator" style="color:#393A34">:</span><span class="token comment" style="color:#999988;font-style:italic">//keycloak.otomi.io/realms/master‚Äú,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"> ‚Äúsub‚Äù</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ‚Äúxyz‚Äù</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"> ‚Äúname‚Äù</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ‚ÄúJoe Doe‚Äù</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"> ‚Äúgroups‚Äù</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"> ‚Äúteam-dev‚Äù</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"> ‚Äúteam-demo‚Äù</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"> ‚Äúgiven_name‚Äù</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ‚ÄúJoe‚Äù</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"> ‚Äúfamily_name‚Äù</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ‚ÄúDoe‚Äù</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"> ‚Äúemail‚Äù</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ‚Äújoe.doe@otomi.io‚Äú</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>There is a ‚ÄúJoe Doe‚Äù user that belongs to team-dev and team-demo groups, which in Harbor can be matched to predefined OIDC groups. The ID token is issued by the Keycloak (iss property) that is running in the same Kubernetes cluster. Harbor can be configured to leverage ID tokens by specifying a set of authentication parameters.</p><p>There is an OIDC endpoint URL, which is matched against iss property from the ID token. Next, OIDC Client ID with OIDC client secret is used by Harbor to authenticate with a client at Keycloak. The group claim name is crucial for enabling Harbor OIDC group matching.</p><p>If you want to perform an automatic user onboarding process you should provide the following OIDC scopes: OpenID (iss and sub-properties) and email scope (email and email_verified properties).</p><p>Do not forget about Keycloak, which requires an additional configuration of the OIDC client.</p><p>The client id is Otomi and the client secret is defined in the credentials tab. There are also valid redirect URLs and Web-origins that have to be set so a user can be redirected from and to the Harbor dashboard upon successful login.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="secure-connectivity-with-istio-service-mesh"></a>Secure Connectivity With Istio Service Mesh<a class="hash-link" href="#secure-connectivity-with-istio-service-mesh" title="Direct link to heading">#</a></h2><p>Istio ensures service interconnectivity, encrypted traffic (mTLS), and routing (VirtualService + Gateways). Integrating Harbor with Istio is mostly about setting up proper URI routing.</p><p>Harbor is composed of ten microservices:</p><ul><li>Chartmuseum</li><li>Clair</li><li>Core</li><li>Database</li><li>Jobservice</li><li>Portal</li><li>Redis</li><li>Registry</li><li>Trivy</li><li>Notary</li></ul><p>The <a href="https://github.com/goharbor/harbor-helm" target="_blank" rel="noopener noreferrer">Harbor Helm chart</a> provides also Nginx as a reverse server proxy service. You don‚Äôt need it, instead, you can deploy the following Istio <a href="https://istio.io/latest/docs/reference/config/networking/virtual-service/" target="_blank" rel="noopener noreferrer">VirtualService</a>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-yaml codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.istio.io/v1beta1</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> VirtualService</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> harbor</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">hosts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"> ‚Äì harbor.otomi.io</span></div><div class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">   ‚Äì match</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">       ‚Äì uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token key atrule" style="color:#00a4db">prefix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ‚Äò/api/‚Äô</span></div><div class="token-line" style="color:#393A34"><span class="token plain">       ‚Äì uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token key atrule" style="color:#00a4db">prefix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ‚Äò/c/‚Äô</span></div><div class="token-line" style="color:#393A34"><span class="token plain">       ‚Äì uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token key atrule" style="color:#00a4db">prefix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ‚Äò/chartrepo/‚Äô</span></div><div class="token-line" style="color:#393A34"><span class="token plain">       ‚Äì uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token key atrule" style="color:#00a4db">prefix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ‚Äò/service/‚Äô</span></div><div class="token-line" style="color:#393A34"><span class="token plain">       ‚Äì uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token key atrule" style="color:#00a4db">prefix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ‚Äò/v1/‚Äô</span></div><div class="token-line" style="color:#393A34"><span class="token plain">       ‚Äì uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token key atrule" style="color:#00a4db">prefix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ‚Äò/v2/‚Äô</span></div><div class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">route</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">       ‚Äì destination</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> harbor</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">harbor</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">core.harbor.svc.cluster.local</span></div><div class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token key atrule" style="color:#00a4db">number</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   ‚Äì match</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">       ‚Äì uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token key atrule" style="color:#00a4db">prefix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /</span></div><div class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">rewrite</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token key atrule" style="color:#00a4db">uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /</span></div><div class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">route</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">       ‚Äì destination</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> harbor</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">harbor</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">portal.harbor.svc.cluster.local</span></div><div class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token key atrule" style="color:#00a4db">number</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The Virtual Services redirect URI paths into Harbor core service:</p><ul><li><code>/api/</code></li><li><code>/c/</code></li><li><code>/chartrepo/</code></li><li><code>/service/</code></li><li><code>/v1/</code></li><li><code>/v2/</code></li></ul><p>All other URI paths are redirected to the Harbor portal service (dashboard).</p><p>The destination hosts from harbor VirtualService is a Fully Qualified Domain Name (FQDN) that indicates the Kubernetes namespace of the Harbor services. It makes it possible for the Istio Ingress gateway to route the incoming traffic.</p><p>You might have noticed that traffic is routed to port 80 (HTTP) instead of 433 (HTTPS). It is because I disabled Harbor internal TLS in favor of the Istio proxy sidecar that enforces mTLS for each Harbor service.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="automation-with-otomi-to-support-multi-tenancy"></a>Automation With Otomi To Support Multi-Tenancy<a class="hash-link" href="#automation-with-otomi-to-support-multi-tenancy" title="Direct link to heading">#</a></h2><p>With Otomi, we strive to integrate best of breed Open-Source projects and provide multi-tenancy awareness out-of-the-box.</p><p>Multi-tenancy is challenging and requires configuration automation to ensure scalability.</p><p>Part of Otomi‚Äôs automation is to configure applications, so they are aware of each other. We do it either by using a declarative approach when that is possible, or else by interacting with their (REST) APIs directly.</p><p>We have generated REST API clients based on the open API specification for Harbor and Keycloak. You are welcome to use <a href="https://github.com/redkubes/otomi-clients" target="_blank" rel="noopener noreferrer">our factory</a></p><p>Next, we implemented idempotent tasks that leverage these REST API clients and automate service configuration. These are run as Kubernetes jobs whenever a configuration changes.For Harbor, we have automated the creation of projects, OIDC groups, project membership, and OIDC settings.</p><p>For Keycloak, we have automated configuration of the external identity provider, group names normalization, deriving Client ID, Client Secret and more. Are you inspired about both? Then take a look at our open-source code.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="pitfalls"></a>Pitfalls<a class="hash-link" href="#pitfalls" title="Direct link to heading">#</a></h2><p>Each OSS project has its own goals and milestones, thus it may be challenging to integrate various projects to work together. Here, I share just a few Issues that I stumbled upon.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="harbor"></a>Harbor<a class="hash-link" href="#harbor" title="Direct link to heading">#</a></h2><p>The container image registry, provided by Harbor, and Docker CLI do not support the OIDC protocol. Instead, it uses a username/password-based authentication. It means that whenever you perform Docker Login/push/pull commands, the HTTPS traffic from a docker client to the container registry does not carry JWT. Make sure to exclude /v1/, /v2/ and /service/ Harbor URI paths from the JWT verification. Otherwise, you won‚Äôt be able to use the registry.</p><p>Next, OIDC users may experience issues with their Docker credentials (CLI secrets) that suddenly are invalidated. The <a href="https://goharbor.io/docs/1.10/administration/configure-authentication/oidc-auth/" target="_blank" rel="noopener noreferrer">CLI secret</a> depends on the validity of the ID token, which has nothing in common with the container registry. This hybrid security solution is something that a regular docker user does not expect and can be a source of many misunderstandings.</p><p>Follow <a href="https://github.com/goharbor/harbor/issues/14172" target="_blank" rel="noopener noreferrer">this</a> thread to get more insights.</p><p>The good news is that if you are an automation freak like me, you don‚Äôt actually need CLI secrets. Instead, you can use <a href="https://goharbor.io/docs/1.10/working-with-projects/project-configuration/create-robot-accounts/" target="_blank" rel="noopener noreferrer">Harbor robot accounts</a> that do not depend on OIDC authentication.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="keycloak-or-other-identity-provider"></a>Keycloak Or Other Identity Provider<a class="hash-link" href="#keycloak-or-other-identity-provider" title="Direct link to heading">#</a></h2><p>If your organization decides to migrate users to another identity provider you may experience a duplicated user error: ‚ÄúConflict, the user with the same username or email has been onboarded‚Äù.</p><p>It is because <strong>sub</strong> and/or <strong>iss</strong> scopes from ID token may change, so the same user trying to login to the harbor dashboard will be treated as a new one. The onboarding process starts but fails because Harbor requires each user to have a unique email address. I ended up removing existing OIDC users from Harbor and allowing them to onboard once again. Interestingly the community of Harbor users is having a broad debate about using OIDC protocol and could not agree on a final solution so far. I encourage you to take a look <a href="https://github.com/goharbor/harbor/issues/14172" target="_blank" rel="noopener noreferrer">here</a> for a very insightful conversation about it.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="istio"></a>Istio<a class="hash-link" href="#istio" title="Direct link to heading">#</a></h2><p>While making Harbor services part of the Istio service mesh, it is very important that Kubernetes services are using port names that follow the Istio convention. For example, the Harbor registry services should have an HTTP-registry port name, instead of a registry. See the following example:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-yaml codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Service</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> harbor</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">harbor</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">registry</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"> ‚Äì name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">registry</span></div><div class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5000</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">protocol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> TCP</span></div><div class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">targetPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5000</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"> ‚Äì name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">controller</span></div><div class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">protocol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> TCP</span></div><div class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">targetPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>If the <strong>service port name</strong> does not follow the Istio convention, Harbor core service is not able to communicate with the Harbor registry service in Istio service mesh. Attempting to login into the Docker registry will end up with an ‚Äúauthentication required‚Äù error.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="takeaways"></a>Takeaways<a class="hash-link" href="#takeaways" title="Direct link to heading">#</a></h2><ul><li>Harbor is a suitable solution for deploying a self-hosted container image repository in a multi-tenant Kubernetes cluster. Nevertheless, the lack of configuration automation makes it hard to maintain it in a constantly changing environment</li><li>Using the OIDC group‚Äôs claim can be used for granting users default role and access to Harbor project(s)</li><li>While working with Istio, do not mess up with named ports</li><li>Stay in touch with open-source communities for projects that you are using, as they are a true treasure trove of information</li></ul><p>I hope that this article provides you a good insight into more advanced Harbor integration in the Kubernetes cluster.</p><p>Part of Otomi‚Äôs automation is to configure applications, so they are aware of each other. We do it either by using a declarative approach when that is possible, or else by interacting with their (REST) APIs directly.</p><p>We have generated REST API clients based on the open API specification for Harbor and Keycloak. You are welcome to use our <a href="https://github.com/redkubes/otomi-clients" target="_blank" rel="noopener noreferrer">factory</a> for building and publishing open API clients.</p><p>This article was originally posted by Jehoszafat Zimnowoda on <a href="https://jzimnowo.medium.com/harbor-keycloak-and-istio-a-good-dance-troupe-6c3520fb87de" target="_blank" rel="noopener noreferrer">medium.com</a>.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/harbor">harbor</a><a class="margin-horiz--sm" href="/blog/tags/otomi">otomi</a><a class="margin-horiz--sm" href="/blog/tags/istio">istio</a><a class="margin-horiz--sm" href="/blog/tags/keycloak">keycloak</a></div><div class="col text--right"><a aria-label="Read more about Integrating Harbor, KeyCloak and Istio" href="/blog/harbor-keycloak-istio"><strong>Read More</strong></a></div></footer></article></div></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Otomi</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/about/">Introduction</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/installation/">Installation</a></li><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="/docs/otomi-console/">Using Otomi Console</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/redkubes/redkubes/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Feedback</a></li><li class="footer__item"><a href="https://gitter.im/redkubes/community" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitter</a></li><li class="footer__item"><a class="footer__link-item" href="/community/get-involved">Get Involved</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Red Kubes</h4><ul class="footer__items"><li class="footer__item"><a href="https://redkubes.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Website</a></li><li class="footer__item"><a href="https://github.com/redkubes/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a href="https://www.linkedin.com/company/red-kubes/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img class="footer__logo" alt="Otomi Open Source Logo" src="/img/otomi-logo-small.svg"></div><div class="footer__copyright">Copyright ¬© 2021 Red Kubes. Built with <a href="https://v2.docusaurus.io/">Docusaurus</a></div></div></div></footer></div>
<script src="/styles.fe6bfec4.js"></script>
<script src="/runtime~main.564d9ca7.js"></script>
<script src="/main.769c3e36.js"></script>
<script src="/1.141f0f27.js"></script>
<script src="/2.5f3907bd.js"></script>
<script src="/3.e819809a.js"></script>
<script src="/6875c492.1d39c8e8.js"></script>
<script src="/382a9fb0.70587f02.js"></script>
<script src="/fcfed33e.3c28ad2b.js"></script>
<script src="/2a9dc24f.fe71cfd5.js"></script>
</body>
</html>