<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.69">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-L2BWYL31EZ"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-L2BWYL31EZ",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Otomi Documentation" href="/opensearch.xml"><title data-react-helmet="true">Our development journey | Otomi Documentation</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-about-current"><meta data-react-helmet="true" property="og:title" content="Our development journey | Otomi Documentation"><meta data-react-helmet="true" name="description" content="Kubernetes offers a cli to send manifests over the wire for clusters to accept or reject. From a developers perspective, it offers nothing to build or help structuring these manifests. So what do you use to manage your manifests?"><meta data-react-helmet="true" property="og:description" content="Kubernetes offers a cli to send manifests over the wire for clusters to accept or reject. From a developers perspective, it offers nothing to build or help structuring these manifests. So what do you use to manage your manifests?"><meta data-react-helmet="true" property="og:url" content="https://otomi.io//about/development-journey"><link data-react-helmet="true" rel="shortcut icon" href="/img/otomi.ico"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link data-react-helmet="true" rel="canonical" href="https://otomi.io//about/development-journey"><link rel="stylesheet" href="/styles.7307db21.css">
<link rel="preload" href="/styles.685d8af2.js" as="script">
<link rel="preload" href="/runtime~main.4d352372.js" as="script">
<link rel="preload" href="/main.db3a2c57.js" as="script">
<link rel="preload" href="/1.a6e2b253.js" as="script">
<link rel="preload" href="/52.294848d2.js" as="script">
<link rel="preload" href="/55.8462c565.js" as="script">
<link rel="preload" href="/7818b736.6537a660.js" as="script">
<link rel="preload" href="/51.999360bc.js" as="script">
<link rel="preload" href="/f948ecd2.f648ab63.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_2AhQ">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" target="_self" href="/"><img src="/img/otomi_logo.svg" alt="Site Logo" class="themedImage_2E_h themedImage--light_AouX navbar__logo"><img src="/img/otomi_logo.svg" alt="Site Logo" class="themedImage_2E_h themedImage--dark_1YPN navbar__logo"></a><a class="navbar__item navbar__link" href="/about/intro">About</a><a class="navbar__item navbar__link" href="/docs/installation">Docs</a><a class="navbar__item navbar__link" href="/docs/console">Otomi Console</a><a class="navbar__item navbar__link" href="/docs/faq">FAQ</a><a class="navbar__item navbar__link" href="/community/support">Community</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/redkubes/otomi-core" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span><span class="DocSearch-Button-Key">âŒ˜</span><span class="DocSearch-Button-Key">K</span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" target="_self" href="/"><img src="/img/otomi_logo.svg" alt="Site Logo" class="themedImage_2E_h themedImage--light_AouX navbar__logo"><img src="/img/otomi_logo.svg" alt="Site Logo" class="themedImage_2E_h themedImage--dark_1YPN navbar__logo"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/about/intro">About</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/installation">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/console">Otomi Console</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/faq">FAQ</a></li><li class="menu__list-item"><a class="menu__link" href="/community/support">Community</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/redkubes/otomi-core" target="_blank" rel="noopener noreferrer" class="menu__link header-github-link" aria-label="GitHub repository"></a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive thin-scrollbar menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">About</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/about/intro">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/about/vision">Vision</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/about/development-journey">Journey</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/about/design-and-architecture">Design &amp; Architecture</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/about/roadmap">Roadmap</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/about/app-suite">App Suite</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_39qw"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">Our development journey</h1></header><div class="markdown"><p>Kubernetes offers a cli to send manifests over the wire for clusters to accept or reject. From a developers perspective, it offers nothing to build or help structuring these manifests. So what do you use to manage your manifests?</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="helm"></a>Helm<a class="hash-link" href="#helm" title="Direct link to heading">#</a></h3><p>After having worked with helm charts for a long time this seemed like a natural fit for a k8s package manager. We also saw that we wanted to consolidate the charts into our own repo, offering control, predictability and enabling offline installs.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="helmfile"></a>Helmfile<a class="hash-link" href="#helmfile" title="Direct link to heading">#</a></h3><p>However, we quickly realized we needed a solution to provide variations of the chart values. When you have multiple clusters for different purposes, differences in environment (i.e. dev vs prod) become a differentiating factor. After reviewing the solutions at the time (jsonnet, helmfile) we decided to stay with Go templating and go for <a href="https://github.com/roboll/helmfile" target="_blank" rel="noopener noreferrer">Helmfile</a>. This offered us all the flexibility to achieve what we want: describing stateful configuration while abstracting away the input. Looking back we are glad to have made this choice, and still believe nothing else comes this close to meet our needs. (Only recently was a small helper tool added to k8s core: kustomize. This is however just a small utility, and it does not offer templating.)</p><p>After having worked with Helmfile however, we discovered that it offered no real best practices when it comes to coding and management, and might be too flexible to come up with a decent architecture. Some setups in the wild had some degree of sanity, but none offered the developers experience we really wanted. After many evolutions organizing our helmfile architecture we settled on something that we are still very happy with. It uses Helmfile&#x27;s alphabetic ordering and reminds of a Unix runlevel.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="layered-yaml-configuration"></a>Layered yaml configuration<a class="hash-link" href="#layered-yaml-configuration" title="Direct link to heading">#</a></h3><p>When modeling configuration for different clusters you come to understand what is shared, and what is unique per cluster. Knowing that helmfile is designed to merge layered yaml files, we settled for a file structure that resembles this understanding. From generic to specific, this made the configuration as <a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself" target="_blank" rel="noopener noreferrer">DRY</a> as we could, limiting human error.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="values-repo"></a>Values repo<a class="hash-link" href="#values-repo" title="Direct link to heading">#</a></h3><p>In the beginning we used our monorepo as is, and kept all the configuration in there as well. But why not make the monorepo stateless itself? And extract the fast moving values to an external storage solution? That offered us the possibility to package up the entire monorepo in a container, and version it. This not only resulted in a clean simple setup in the monorepo with only Go templating, but now we have an external repo with yaml configuration that is extremely suitable for GitOps.</p><p>From a developers perspective, having made this seperation of concerns made a lot of sense. Only values exist in the repo, so auditing the trail of changes becomes easy. Just look at the commit diff. The core is now essentially a product (albeit one of many parts with lots of glue) that can evolve over time.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="gitops-with-drone"></a>GitOps with Drone<a class="hash-link" href="#gitops-with-drone" title="Direct link to heading">#</a></h3><p>After having automated the delivery of our monorepo as a docker image, we could finally automate GitOps deployment. However, after having worked with Weave Flux extensively, we came to see that most of these GitOps solutions are an overkill to what we need, and do not support our DRY way of working. Most of the GitOps solutions out there make you use custom resources to tell you what to sync and what not, making you build and maintain a lot of glue to do what should be very easy. We just want to apply changing values using versioned artifacts. We don&#x27;t want to keep code in sync, just configuration.</p><p>So we decided to keep it simple (stupid) and use good old Drone, which is triggered by git webhook to just do what we, as developers do: deploy the changed motherload to the cluster that is interested in receiving those changes. We did not have to deviate from the developers workflow, and could even model it the same way, using the same tooling.</p><p>One thing that we don&#x27;t like about it: it is webhook based (push), and does not retry when the hook is not working. We will soon have a solution that allows for periodic syncing.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="single-sign-on-with-keycloak"></a>Single Sign On with Keycloak<a class="hash-link" href="#single-sign-on-with-keycloak" title="Direct link to heading">#</a></h3><p>We were using <a href="https://github.com/oauth2-proxy/oauth2-proxy" target="_blank" rel="noopener noreferrer">oauth2-proxy</a> from the beginning, and were able to use it for SSO just fine, for a while. We had enabled a lot of OIDC aware applications when we started seeing the beauty of normalizing an OIDC JWT&#x27;s payload. This would allow applications to just consume the provided JWT without having to run a client to talk to the IDP. That is how we chose to put <a href="https://www.keycloak.org" target="_blank" rel="noopener noreferrer">Keycloak</a> in between oauth2-proxy and external IDPs, because it is very good at that. It has lots of knobs and settings to talk to exotic IDPs and translate incoming properties and claims.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="running-tasks"></a>Running tasks<a class="hash-link" href="#running-tasks" title="Direct link to heading">#</a></h3><p>Since we are effectively configuring open source applications, we needed a way to run <a href="https://github.com/redkubes/otomi-tasks/" target="_blank" rel="noopener noreferrer">tasks</a> at the right moments in the deployment lifecycle. Example: Keycloak needs to be told how applications can reach it, before any of the crucial ones actually do. Istio won&#x27;t forward a request when it is told to authenticate but can&#x27;t reach Keycloak.</p><p>To be able to easily generate openapi typescript clients for tasks to talk to the applications, we have also created a small repo named <a href="https://github.com/redkubes/otomi-clients/" target="_blank" rel="noopener noreferrer">otomi-clients</a>. We were already using typescript for our NodeJS API and Console UI, so this was an easy choice for us.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="test-and-validate-everything"></a>Test and validate everything<a class="hash-link" href="#test-and-validate-everything" title="Direct link to heading">#</a></h3><p>After unknowingly delivering breaking changes too many times, we went all the way and decided to validate all input and output as best as we can.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="input-checks"></a><strong>Input checks</strong><a class="hash-link" href="#input-checks" title="Direct link to heading">#</a></h4><p>We introduced a jsonschema validation routine that can be used statically by your editor (in VSCode this works out of the box), but is also used pre-commit to avoid broken configuration.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="output-checks"></a><strong>Output checks</strong><a class="hash-link" href="#output-checks" title="Direct link to heading">#</a></h4><p>After having settled for <a href="https://www.openpolicyagent.org" target="_blank" rel="noopener noreferrer">OPA</a> as our policy management solution, we came up with an elaborate approach to have Universal OPA Policies (akin to Universal Javascript). We crafted a mix of <a href="https://www.conftest.dev" target="_blank" rel="noopener noreferrer">Conftest</a> and custom CRD/CR extraction routines to check if all the manifests are adhering to k8s best practices and the OPA policies we settled for. This allows not only for static validation, but also for OPA gatekeeper to uphold these same policies on the cluster.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="smooth-sailing"></a>Smooth sailing<a class="hash-link" href="#smooth-sailing" title="Direct link to heading">#</a></h2><p>Having built a very flexible and easily approachable development platform for kubernetes solutions, we can truly say we are now smooth sailing. We just keep building out the functionality in the core, and expose more and more configuration for values to manipulate.</p><p>Of course there are sometimes unforeseen waves rocking our boat, and we try to be ready for when they come. We invite you to look at our <a href="/about/roadmap">roadmap</a> to see potential problems we have identified so far, but also the opportunities waiting to land.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/redkubes/redkubes/edit/master/about/about-journey.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col text--right"><em><small>Last updated on <time datetime="2020-12-04T16:07:10.000Z" class="docLastUpdatedAt_217_">12/4/2020</time> by <strong>Maurice Faber</strong></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/about/vision"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Vision</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/about/design-and-architecture"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Otomi Container Platform Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_ thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#helm" class="table-of-contents__link">Helm</a></li><li><a href="#helmfile" class="table-of-contents__link">Helmfile</a></li><li><a href="#layered-yaml-configuration" class="table-of-contents__link">Layered yaml configuration</a></li><li><a href="#values-repo" class="table-of-contents__link">Values repo</a></li><li><a href="#gitops-with-drone" class="table-of-contents__link">GitOps with Drone</a></li><li><a href="#single-sign-on-with-keycloak" class="table-of-contents__link">Single Sign On with Keycloak</a></li><li><a href="#running-tasks" class="table-of-contents__link">Running tasks</a></li><li><a href="#test-and-validate-everything" class="table-of-contents__link">Test and validate everything</a></li><li><a href="#smooth-sailing" class="table-of-contents__link">Smooth sailing</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Otomi</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/about/intro">Introduction</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/console">Community Edition</a></li><li class="footer__item"><a href="https://redkubes.com/otomi-container-platform-product-sheet/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Product sheet</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/redkubes/redkubes/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Feedback</a></li><li class="footer__item"><a href="https://gitter.im/redkubes/community" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitter</a></li><li class="footer__item"><a class="footer__link-item" href="/community/support">Help</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Red Kubes</h4><ul class="footer__items"><li class="footer__item"><a href="https://redkubes.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Website</a></li><li class="footer__item"><a href="https://github.com/redkubes/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a href="https://www.linkedin.com/company/red-kubes/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIN</a></li></ul></div></div><div class="text--center"><div class="margin-bottom--sm"><img class="footer__logo" alt="Otomi Open Source Logo" src="/img/otomi_logo_small.svg"></div><div>Copyright Â© 2020 Red Kubes. Built with <a href="https://v2.docusaurus.io/">Docusaurus</a></div></div></div></footer></div>
<script src="/styles.685d8af2.js"></script>
<script src="/runtime~main.4d352372.js"></script>
<script src="/main.db3a2c57.js"></script>
<script src="/1.a6e2b253.js"></script>
<script src="/52.294848d2.js"></script>
<script src="/55.8462c565.js"></script>
<script src="/7818b736.6537a660.js"></script>
<script src="/51.999360bc.js"></script>
<script src="/f948ecd2.f648ab63.js"></script>
</body>
</html>