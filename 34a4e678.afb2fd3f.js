(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{124:function(e,t,n){"use strict";n.d(t,"a",(function(){return p})),n.d(t,"b",(function(){return u}));var r=n(0),a=n.n(r);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var c=a.a.createContext({}),d=function(e){var t=a.a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},p=function(e){var t=d(e.components);return a.a.createElement(c.Provider,{value:t},e.children)},b={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},m=a.a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,i=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),p=d(n),m=r,u=p["".concat(i,".").concat(m)]||p[m]||b[m]||o;return n?a.a.createElement(u,l(l({ref:t},c),{},{components:n})):a.a.createElement(u,l({ref:t},c))}));function u(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var c=2;c<o;c++)i[c]=n[c];return a.a.createElement.apply(null,i)}return a.a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},81:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return i})),n.d(t,"metadata",(function(){return l})),n.d(t,"rightToc",(function(){return s})),n.d(t,"default",(function(){return d}));var r=n(3),a=n(7),o=(n(0),n(124)),i={slug:"troubleshooting/cli",title:"Troubleshooting: Otomi CLI",sidebar_label:"Otomi CLI"},l={unversionedId:"ts-cli",id:"ts-cli",isDocsHomePage:!1,title:"Troubleshooting: Otomi CLI",description:"The otomi (diff|apply|sync|template) commands are delegated to helmfile, which in turn delegates the deployment work to helm. Sometimes it is not clear wether the issue is from Helm or Helmfile, so we will address them together in this section.",source:"@site/docs/ts-cli.md",slug:"/troubleshooting/cli",permalink:"/docs/troubleshooting/cli",editUrl:"https://github.com/redkubes/redkubes/tree/master/docs/ts-cli.md",version:"current",sidebar_label:"Otomi CLI",sidebar:"mainSidebar",previous:{title:"Troubleshooting Overview",permalink:"/docs/troubleshooting"},next:{title:"Troubleshooting: Harbor",permalink:"/docs/troubleshooting/harbor"}},s=[{value:"State drift",id:"state-drift",children:[]},{value:"Deployment errors",id:"deployment-errors",children:[{value:"1. It can&#39;t deploy a resource when it already exists",id:"1-it-cant-deploy-a-resource-when-it-already-exists",children:[]},{value:"2. Release&#39;s latest state is failed",id:"2-releases-latest-state-is-failed",children:[]},{value:"3. Some resources couldn&#39;t be patched",id:"3-some-resources-couldnt-be-patched",children:[]}]}],c={rightToc:s};function d(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(o.b)("wrapper",Object(r.a)({},c,n,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,"The ",Object(o.b)("inlineCode",{parentName:"p"},"otomi (diff|apply|sync|template)")," commands are delegated to ",Object(o.b)("inlineCode",{parentName:"p"},"helmfile"),", which in turn delegates the deployment work to ",Object(o.b)("inlineCode",{parentName:"p"},"helm"),". Sometimes it is not clear wether the issue is from Helm or Helmfile, so we will address them together in this section."),Object(o.b)("h2",{id:"state-drift"},"State drift"),Object(o.b)("p",null,Object(o.b)("strong",{parentName:"p"},"Problem"),": ",Object(o.b)("inlineCode",{parentName:"p"},"otomi apply")," does not seem to change resources."),Object(o.b)("p",null,Object(o.b)("strong",{parentName:"p"},"Solution"),": try ",Object(o.b)("inlineCode",{parentName:"p"},"otomi sync")),Object(o.b)("p",null,Object(o.b)("strong",{parentName:"p"},"Background info"),":"),Object(o.b)("p",null,"The ",Object(o.b)("inlineCode",{parentName:"p"},"otomi apply")," command uses helmfile's ",Object(o.b)("inlineCode",{parentName:"p"},"apply")," command, which combines its ",Object(o.b)("inlineCode",{parentName:"p"},"diff")," and ",Object(o.b)("inlineCode",{parentName:"p"},"sync")," commandds. So it first does a ",Object(o.b)("inlineCode",{parentName:"p"},"helmfile diff")," against helm's bookeeping (which resides in versioned secrets, e.g. ",Object(o.b)("inlineCode",{parentName:"p"},"sh.helm.release.v1.loki.v1"),"). This is the most cost effective way and does not lead to a new release version being deployed when there are no changes. However, when you changed cluster resources without the otomi cli (so without using helm) this is not reflected in the secrets. ",Object(o.b)("inlineCode",{parentName:"p"},"helmfile diff")," will not see any changes in the secret, so it won't execute the subsequent ",Object(o.b)("inlineCode",{parentName:"p"},"helmfile sync"),". If you wish to overwrite the desired state on the cluster, use the ",Object(o.b)("inlineCode",{parentName:"p"},"otomi sync -l name=$releaseName")," command directly. Usually only for a certain release, so you don't force change all the releases, which costs a lot of time."),Object(o.b)("h2",{id:"deployment-errors"},"Deployment errors"),Object(o.b)("p",null,"Helmfile uses Helm 3 under the hood, and it will throw errors in certain situations:"),Object(o.b)("h3",{id:"1-it-cant-deploy-a-resource-when-it-already-exists"},"1. It can't deploy a resource when it already exists"),Object(o.b)("p",null,"When a resource already exists and was not deployed with the chart before (alien to Helm), it is possible to 'adopt' the resource beforehand by labeling and annotating them correctly:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-bash"}),"k -n $NS annotate --overwrite $KIND $NAME meta.helm.sh/release-name=$RELEASE\nk -n $NS annotate --overwrite $KIND $NAME meta.helm.sh/release-namespace=$NAMESPACE\nk -n $NS label --overwrite $KIND $NAME app.kubernetes.io/managed-by=Helm\n")),Object(o.b)("p",null,"This functionality exists in the stack in ",Object(o.b)("inlineCode",{parentName:"p"},"bin/upgrades/adopt-by-helm.sh"),", and is used in the upgrade scripts."),Object(o.b)("h3",{id:"2-releases-latest-state-is-failed"},"2. Release's latest state is failed"),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},'Error: "$releaseName" has no deployed releases')),Object(o.b)("p",null,"This may happen when you try to install a chart (usually for the first time) and it fails. This results in the release's deployment having state 'failed'."),Object(o.b)("p",null,Object(o.b)("strong",{parentName:"p"},"Solution"),":"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"When this was the first install: destroy with ",Object(o.b)("inlineCode",{parentName:"li"},"otomi hf -l name=$releaseName destroy")," and then apply with ",Object(o.b)("inlineCode",{parentName:"li"},"otomi apply -l name=$releaseName")," again."),Object(o.b)("li",{parentName:"ul"},"When the was successfully deployed before: remove the last versioned helm secret that is causing the blockage (e.g. ",Object(o.b)("inlineCode",{parentName:"li"},"sh.helm.release.v1.loki.v3"),")")),Object(o.b)("h3",{id:"3-some-resources-couldnt-be-patched"},"3. Some resources couldn't be patched"),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"Error: UPGRADE FAILED: failed to replace object: ... field is immutable")),Object(o.b)("p",null,"This usually happens when a manifest is not allowed to be patched in place and needs to be replaced. Retry the borking release with ",Object(o.b)("inlineCode",{parentName:"p"},"otomi apply -l name=$releaseName --extraArgs='--force=true'")," which does exactly that."))}d.isMDXComponent=!0}}]);